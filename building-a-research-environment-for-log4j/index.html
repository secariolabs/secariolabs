<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/css/main.css" /><title>Building a Research Environment for Log4j - Secario Labs</title>
  <meta
    name="description"
    content="With its widespread adoption rate and the challenge enterprises face with tracking down where it is being used, log4j would likely continue to be a relevant attack vector for quite a long time. Because of this, we decided to showcase how one would go about building a local lab that..."
  /><link
    rel="canonical"
    href="https://secariolabs.github.io/building-a-research-environment-for-log4j/"
  /><link rel="icon" type="image/png" href="/assets/images/favicon/favicon-96x96--white.png" sizes="96x96" media="(prefers-color-scheme: dark)">
<link rel="icon" type="image/svg+xml" href="/assets/images/favicon/favicon--white.svg" media="(prefers-color-scheme: dark)">
<link rel="icon" type="image/png" href="/assets/images/favicon/favicon-96x96.png" sizes="96x96" media="(prefers-color-scheme: light)">
<link rel="icon" type="image/svg+xml" href="/assets/images/favicon/favicon.svg" media="(prefers-color-scheme: light)">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon/apple-touch-icon.png">
<meta name="apple-mobile-web-app-title" content="SecarioLabs">
<link rel="manifest" href="/site.webmanifest"><meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@SecarioLabs" />
<meta name="twitter:title" content="Building a Research Environment for Log4j" />
<meta name="twitter:description" content="With its widespread adoption rate and the challenge enterprises face with tracking down where it is being used, log4j would likely continue to be a relevant attack vector for quite a long time. Because of this, we decided to showcase how one would go about building a local lab that..." />
<meta name="twitter:image" content="https://secariolabs.github.io/assets/images/posts/image-4.png" />

<meta property="og:type" content="article" />
<meta property="og:title" content="Building a Research Environment for Log4j" />
<meta property="og:description" content="With its widespread adoption rate and the challenge enterprises face with tracking down where it is being used, log4j would likely continue to be a relevant attack vector for quite a long time. Because of this, we decided to showcase how one would go about building a local lab that..." />
<meta property="og:url" content="https://secariolabs.github.io/building-a-research-environment-for-log4j/" />
<meta property="og:image" content="https://secariolabs.github.io/assets/images/posts/image-4.png" />
<link type="application/atom+xml" rel="alternate" href="https://secariolabs.github.io/feed.xml" title="Your awesome title" /></head>
<body data-prismjs-copy='' data-prismjs-copy-success=''><header  id="site-header"  class="site-header"><div class="banner hidden" id="banner">
    <div class="container container--xl">
        <p class="banner__title">
            <strong>We’ll beat any Web Application Penetration Test Quote You've Received <em>By 15%!</em></strong>
        </p>
        <p><a class="text-muted text-xs" href="/terms-and-conditions/">
                    Terms and coditions apply
                </a></p>
    </div><div class="banner__tag">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="#921F20" viewBox="0 0 100 100"><path d="M61.223 61.836c0 4.492-6.734 4.492-6.734 0 0-4.488 6.734-4.488 6.734 0M45.512 46.223c0 4.492-6.734 4.492-6.734 0 0-4.488 6.734-4.488 6.734 0"/><path d="m27.551 85.203 21.328-12.961c.203-.203.715-.203 1.02-.203.203 0 .406 0 .613.203L71.43 85.203v-53.57H27.55zm30.305-16.938a6.403 6.403 0 0 1-6.43-6.43c0-3.57 2.856-6.43 6.43-6.43 3.57 0 6.43 2.856 6.43 6.43 0 3.57-2.856 6.43-6.43 6.43zm4.695-26.836a1.601 1.601 0 0 1 0 2.246L40.305 65.917a1.578 1.578 0 0 1-2.144.102l-.102-.102a1.69 1.69 0 0 1 0-2.144l22.348-22.348a1.695 1.695 0 0 1 2.145.004zm-20.406-1.633c3.57 0 6.43 2.856 6.43 6.43 0 3.57-2.856 6.43-6.43 6.43-3.57-.102-6.328-2.856-6.43-6.43a6.4 6.4 0 0 1 6.43-6.43zM27.551 15.305H71.43v13.266H27.551z"/></svg>
        </div><button class="banner__close" id="close-banner">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon icon-tabler icons-tabler-outline icon-tabler-x" viewBox="0 0 24 24"><path stroke="none" d="M0 0h24v24H0z"/><path d="M18 6 6 18M6 6l12 12"/></svg>
    </button>
</div><nav id="site-nav" class="site-nav">
        <div class="container container--xl">
            <a href="/" class="site-nav__logo-link">
                <img class="site-nav__logo" src="/assets/images/secario-labs-logo.png" alt="Secario Labs logo" width="462" height="58">
            </a>

            <ul class="site-nav__items" id="nav">
                
                    <li class="site-nav__item"><a href="/about-us" class="site-nav__link">About Us</a></li>
                
                    <li class="site-nav__item"><a href="/services/" class="site-nav__link">Services</a></li>
                
                    <li class="site-nav__item"><a href="/defence/" class="site-nav__link">Defence</a></li>
                
                    <li class="site-nav__item"><a href="/blog/" class="site-nav__link site-nav__link--active">Blog</a></li>
                
                    <li class="site-nav__item"><button class="btn btn--md btn--light uppercase" data-open-modal>Book a call</button></li>
                
            </ul>

            <button class="burger" id="menu-btn"><svg width="32" height="32">
    <rect id="line1" y="8" width="32" height="2"></rect>
    <rect id="line2" y="16" width="32" height="2"></rect>
    <rect id="line3" y="24" width="32" height="2"></rect>
</svg></button>
        </div>
    </nav>

</header><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-ffffff-1">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 1"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 1"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 1"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-4">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-000000-ffffff-5">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0 1"></feFuncR>
        <feFuncG type="table" tableValues="0 1"></feFuncG>
        <feFuncB type="table" tableValues="0 1"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-c93b3b-ffffff-7">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.78823529411765 1"></feFuncR>
        <feFuncG type="table" tableValues="0.23137254901961 1"></feFuncG>
        <feFuncB type="table" tableValues="0.23137254901961 1"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-1">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-2">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-3">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg><main aria-label="Content">
      <section class="hero hero--page hero--post"  style="background-image: linear-gradient(0deg, rgba(0, 0, 0, 0.6) 0%,
  rgba(0, 0, 0, 0.7) 100%), url(/assets/images/posts/image-4.png);" >

  <div class="container container--sm">
    <h1 class="hero__heading hero__heading--page hero__heading--post">Building a Research Environment for Log4j</h1><div class="blog__teaser-meta">
    <div class="blog__teaser-date-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24"><path d="M4 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7zM16 3v4M8 3v4M4 11h16M7 14h.013M10.01 14h.005M13.01 14h.005M16.015 14h.005M13.015 17h.005M7.01 17h.005M10.01 17h.005"/></svg>
        <time datetime="2023-03-03T20:35:05+00:00" class="span blog__teaser-date text-sm">
            March  3, 2023
        </time>
    </div><div class="blog__teaser-tags-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24"><path d="M3 8v4.172a2 2 0 0 0 .586 1.414l5.71 5.71a2.41 2.41 0 0 0 3.408 0l3.592-3.592a2.41 2.41 0 0 0 0-3.408l-5.71-5.71A2 2 0 0 0 9.172 6H5a2 2 0 0 0-2 2z"/><path d="m18 19 1.592-1.592a4.82 4.82 0 0 0 0-6.816L15 6M7 10h-.01"/></svg>
            <div class="blog__teaser-tags">
                <span class="blog__teaser-tag text-sm text-light">Apache</span>, <span class="blog__teaser-tag text-sm text-light">DNS resolver</span>
            </div>
        </div></div></div>
</section><section class="post-wrapper">
  <section class="section section--page section--post">
    <div class="container container--sm">
      <div class="post__bc text-muted">
        <a
          class="post__bc-item text-muted underline"
          href="/"
          >Home</a
        >
        »
        <a
          class="post__bc-item text-muted underline"
          href="/blog/"
          >Blog</a
        >
        »
        <strong class="post__bc-item text-muted post__bc-item--active"
          >Building a Research Environment for Log4j</strong
        >
      </div>

      <article class="post"><p>With its widespread adoption rate and the challenge enterprises face with tracking down where it is being used, log4j would likely continue to be a relevant attack vector for quite a long time. Because of this, we decided to showcase how one would go about building a local lab that could be used both for developing and testing an exploit, as well as help to confirm and adapt remedial actions.</p>

<p>For background, whenever we refer to the Apache log4j vulnerability, we mean the following CVEs:</p>

<ul>
  <li>CVE-2021-44228</li>
  <li>CVE-2021-45046</li>
  <li>CVE-2021-45105</li>
</ul>

<h2 id="1-building-the-vulnerable-server">1. Building the Vulnerable Server</h2>

<p>Due to the many conditions and elements included in this vulnerability, which significantly influence the impact and the possible steps for remediation, we found that to be able to test and obtain realistic results that can then confidently be relied on, we had to be very precise when setting up the environment. For example, the version of JDK, the version of log4j, the operating system, the running DNS resolver services, the log4j configuration file, the Java configuration file, the environment variables, as well as what other libraries are being included in the application can all make the exploitation and patching of this issue slightly different.</p>

<p>And because of this, it is important to make sure that all the software matches the one of the target application. To that end, in this article, you will see that we pay particular attention not only to the version of log4j but also to Java as it also plays an important role in the exploit.</p>

<p>We will cover three different ways of building a vulnerable server:</p>

<h3 id="docker-container"><strong>Docker Container</strong></h3>

<p>Start right away with Docker, which is by far the easiest to set up. OpenJDK (an open-source implementation of the Java Platform, Standard Edition) offers <a href="https://hub.docker.com/_/openjdk">all the versions of Java</a> that you may need; ready to be downloaded and used.</p>

<p>Keep in mind that JDK versions greater than 6u211, 7u201, 8u191, and 11.0.1 are not affected by the LDAP attack vector. In these versions <code class="language-plaintext highlighter-rouge">com.sun.jndi.ldap.object.trustURLCodebase</code> is set to <em>false</em> meaning JNDI cannot load remote code using LDAP. However, the vulnerability is still exploitable using other methods, such as <a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java">beanfactory</a>.</p>

<p>In the example below you will see how easy it is to download JDK 8u171 and jump right into it:</p>

<p><img src="/assets/images/posts/image-13.png" alt="" /></p>

<h3 id="linux-virtual-machine"><strong>Linux Virtual Machine</strong></h3>

<p>Alternatively, if you prefer to set up the testing environment directly on a Linux server, it is still relatively easy. You can go to the <a href="https://secariolabs.com/building-a-research-environment-for-log4j/o%09https:/www.oracle.com/uk/java/technologies/javase/javase8-archive-downloads.html">Java SE archive</a> and select the version of Java that you need (we recommend the tar.gz format).</p>

<p>Once the version is downloaded, it is just a matter of extracting the archive, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@ubuntu:~/poc<span class="nv">$ </span>ll <span class="nt">-Ah</span>
total 183M
<span class="nt">-rw-rw-r--</span> 1 user user 183M Dec 20 02:13 jdk-8u171-linux-x64.tar.gz

user@ubuntu:~/poc<span class="nv">$ </span><span class="nb">tar </span>zxvf jdk-8u171-linux-x64.tar.gz
<span class="o">[</span>...snip...]

user@ubuntu:~/poc<span class="nv">$ </span>ll <span class="nt">-Ah</span>
total 183M
drwxr-xr-x 8 user user 4.0K Mar 28  2018 jdk1.8.0_171/
<span class="nt">-rw-rw-r--</span> 1 user user 183M Dec 20 02:13 jdk-8u171-linux-x64.tar.gz

user@ubuntu:~/poc<span class="nv">$ </span>./jdk1.8.0_171/bin/java <span class="nt">-version</span>
java version <span class="s2">"1.8.0_171"</span>
Java<span class="o">(</span>TM<span class="o">)</span> SE Runtime Environment <span class="o">(</span>build 1.8.0_171-b11<span class="o">)</span>
Java HotSpot<span class="o">(</span>TM<span class="o">)</span> 64-Bit Server VM <span class="o">(</span>build 25.171-b11, mixed mode<span class="o">)</span>

</code></pre></div></div>

<h3 id="windows-virtual-machine"><strong>Windows Virtual Machine</strong></h3>

<p>Unlike the previous two options, downloading Java on Windows system without actually installing it, is slightly more involved. It all starts the same way: by downloading the wanted version of Java from the <a href="https://www.oracle.com/uk/java/technologies/javase/javase8-archive-downloads.html">Java SE archive</a>, but then rather than installing it we will have to do a few steps.</p>

<p>As initially described by <a href="https://stackoverflow.com/questions/1619662/how-can-i-get-the-latest-jre-jdk-as-a-zip-file-rather-than-exe-or-msi-installe">Igor on Stack Overflow</a>:</p>

<p><strong>Step 1:</strong> Download and install <a href="https://www.7-zip.org/download.html">7zip</a></p>

<p><strong>Step 2:</strong> Unarchive the executable “jdk-XuXX-windows-x64.exe” with 7zip, as shown below:</p>

<p><img src="/assets/images/posts/image-14-1024x392.png" alt="" /></p>

<p><strong>Step 3:</strong> Run <code class="language-plaintext highlighter-rouge">extrac32 111</code> within the <code class="language-plaintext highlighter-rouge">.rsrc\1033\JAVA_CAB10</code> folder, as shown below:</p>

<p><img src="/assets/images/posts/image-15.png" alt="" /></p>

<p><strong>Step 4:</strong> Extract the “tools.zip” archive in the same folder using 7zip</p>

<p><strong>Step 5:</strong> Run <code class="language-plaintext highlighter-rouge">for /r %x in (*.pack) do .\bin\unpack200 -r "%x" "%~dx%~px%~nx.jar"</code> within the newly created “tools” folder, as shown below:</p>

<p><img src="/assets/images/posts/image-16.png" alt="" /></p>

<p><strong>Step 6:</strong> Recursively copy the contents of the “tools” folder to a location where JDK would be located; in the screenshot below the new folder would be <code class="language-plaintext highlighter-rouge">C:\jdk-8u171</code>.</p>

<p><img src="/assets/images/posts/image-17.png" alt="" /></p>

<p><strong>Step7:</strong> Verify that Java has been installed successfully:</p>

<p><img src="/assets/images/posts/image-18.png" alt="" /></p>

<h2 id="2-building-the-vulnerable-application">2. Building the Vulnerable Application</h2>

<p>With a working server, the next step would be to download the version of log4j that would be used for testing. This could be achieved by downloading the (tar.gz or zip) library from <a href="https://archive.apache.org/dist/logging/log4j/">Apache’s archive</a>.</p>

<p>In our case, that was version 2.14.1 of log4j, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@ubuntu:~/poc<span class="nv">$ </span>wget <span class="nt">-q</span> https://archive.apache.org/dist/logging/log4j/2.14.1/apache-log4j-2.14.1-bin.tar.gz
user@ubuntu:~/poc<span class="nv">$ </span><span class="nb">tar </span>zxf apache-log4j-2.14.1-bin.tar.gz
user@ubuntu:~/poc<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> apache-log4j-2.14.1-bin/log4j-<span class="o">{</span>api,core<span class="o">}</span><span class="nt">-2</span>.14.1.jar
<span class="nt">-rw-r--r--</span> 1 user user  300364 Mar  6  2021 apache-log4j-2.14.1-bin/log4j-api-2.14.1.jar
<span class="nt">-rw-r--r--</span> 1 user user 1745701 Mar  6  2021 apache-log4j-2.14.1-bin/log4j-core-2.14.1.jar

</code></pre></div></div>

<p>Once that is completed, the next step is to either recreate the application you are targeting, or a simple dummy one where you can work on the attack. A short piece of code that would be able to invoke the vulnerability has been included below:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.logging.log4j.LogManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.logging.log4j.Logger</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">POC</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="no">POC</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"${jndi:ldap://example.com/z}"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>To compile the script, it is important to include both the “core” and the “api” libraries:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@ubuntu:~/poc<span class="nv">$ </span>./jdk1.8.0_171/bin/javac <span class="nt">-cp</span> apache-log4j-2.14.1-bin/log4j-core-2.14.1.jar:apache-log4j-2.14.1-bin/log4j-api-2.14.1.jar POC.java
</code></pre></div></div>

<p>To run the script, it is once again required to include both libraries as well as the current folder:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@ubuntu:~/poc$ ./jdk1.8.0_171/bin/java -cp apache-log4j-2.14.1-bin/log4j-core-2.14.1.jar:apache-log4j-2.14.1-bin/log4j-api-2.14.1.jar:. POC
14:27:56.562 [main] ERROR POC - ${jndi:ldap://example.com/z}

</code></pre></div></div>

<p><em>Note that the vulnerable application hangs once executed, as an LDAP request is being made in the background and it will need to timeout.</em></p>

<h2 id="3-testing-the-proof-of-concept">3. Testing the Proof-Of-Concept</h2>

<p>At this point, the last element needed to complete the basic research environment would be to obtain visibility over the network traffic. Ideally, that would be done with a custom LDAP/DNS/RMI server that would be able to provide a clear indication of the request and any metadata it carries, as well as control over what data is sent back to the vulnerable application; however, some of that could be achieved with a simple packet analyser that can show if a request is being made, even if nothing is sent back. For a lot of the cases that should be enough to prove if the application is (still) vulnerable.</p>

<p>We would recommend Wireshark as it will be easy to see the different protocols and it is very intuitive to apply filters (unlike tcpdump). With it running (do not forget to execute it with elevated privileges), listening on all interfaces, you should be able to rerun the POC script and see the network traffic, as shown below:</p>

<p><img src="/assets/images/posts/image-19.png" alt="" /></p>

<p>That concludes our small testing environment for log4j. In our next blog post, we would focus more on exploiting the vulnerability and research different patching methods.</p>
</article><div class="post__nav-wrapper">
        <h3 class="post__nav-heading">More articles</h3>

        <div class="post__nav"><a
            class="post__nav-item post__nav-item--prev"
            href="/analysing-and-reproducing-poc-for-log4j-2-15-0/"
          >Analysing and Reproducing PoC for Log4j 2.15.0</a><a
            class="post__nav-item post__nav-item--next"
            href="/protecting-assets-behind-cloudfront/"
          >Protecting Assets Behind CloudFront</a></div>
      </div></div>
  </section>
</section><div id="lightbox" class="lightbox opacity-0 z_-10">
    <figure id="lightbox-figure" class="lightbox__figure">
        <img src="" alt="" class="lightbox__img">
        <figcaption class="lightbox__caption"></figcaption>
        <svg id="close-lightbox-control" class="lightbox__close" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>
    </figure>
</div>
    </main><footer class="site-footer">
    <div class="container">

        <div class="site-footer__logo-wrapper">
            <a href="/" class="site-footer__logo-link">
                <img class="site-footer__logo" src="/assets/images/secario-labs-logo.png" alt="Secario Labs logo" width="462" height="58">
            </a>
        </div>

        <div class="site-footer__cols site-footer__cols--3">

            <div class="site-footer__col site-footer__col--desc">

                <div class="site-footer__desc">
                    <p>Secario Labs offers expertly delivered cyber security services, security testing and solutions that are geared to your risk profile and security needs. Combining skills, experience and methodologies to provide offensive cyber security solutions.</p>

                </div>
            </div>

            <div class="site-footer__col site-footer__col--location">
                <p>
                    <strong>Bulgaria Office</strong><br>
                    66 Vitosha Blvd.<br>Sofia, 1463<br>Bulgaria
                </p>
                <p>
                    <a class="site-footer__link" href="tel:+359882357332">
                        +359 882 357332
                    </a>
                    <br>
                    <a class="site-footer__link" href="mailto:info@secariolabs.com">
                        info@secariolabs.com
                    </a>
                </p>
            </div>

            <div class="site-footer__col site-footer__col--location">
                <p>
                    <strong>UK Office</strong><br>
                    Worth Corner, Pound Hill,<br>Crawley, RH10 7SL<br>United Kingdom
                </p>
                <p>
                    <a class="site-footer__link" href="tel:+447389796754">
                        +44 7389 796754
                    </a>
                    <br>
                    <a class="site-footer__link" href="mailto:info@secariolabs.com">
                        info@secariolabs.com
                    </a>
                </p>                
            </div>

        </div>

        <div class="site-footer__cols site-footer__cols--2">
            <div class="site-footer__col">
                <label class="site-footer__form-label" for="email">Sign up to our newsletter</label><div id="mc_embed_shell">
    <link href="//cdn-images.mailchimp.com/embedcode/classic-061523.css" rel="stylesheet" type="text/css">
    <div id="mc_embed_signup">
        <form action="https://secariolabs.us6.list-manage.com/subscribe/post?u=daf217615566079f0ccc22426&amp;id=9fa5ad3243&amp;f_id=002628e3f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank">
            <div id="mc_embed_signup_scroll" class="site-footer__form-fields">
                <input type="email" name="EMAIL" class="required email input__text input__text--xl" id="mce-EMAIL" required="" value="" placeholder="Your email">
                <div style="position: absolute; left: -5000px;" aria-hidden="true">
                    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups -->
                    <input type="text" name="b_daf217615566079f0ccc22426_9fa5ad3243" tabindex="-1" value="">
                </div>
                <div class="optionalParent">
                    <div class="clear foot">
                        <input type="submit" name="subscribe" id="mc-embedded-subscribe" class="site-footer__form-submit btn btn--xl btn--light uppercase" value="Subscribe"></div>
                </div>
            </div>

            <div id="mce-responses" class="clear foot">
                <div class="response" id="mce-error-response" style="display: none;">😐 Error!</div>
                <div class="response" id="mce-success-response" style="display: none;">✅ Success!</div>
            </div>
        </form>
    </div>
    <script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script>
    <script type="text/javascript">
        (function($) {
            window.fnames = new Array();
            window.ftypes = new Array();
            fnames[0] = 'EMAIL';
            ftypes[0] = 'email';
            fnames[1] = 'FNAME';
            ftypes[1] = 'text';
            fnames[2] = 'LNAME';
            ftypes[2] = 'text';
            fnames[3] = 'ADDRESS';
            ftypes[3] = 'address';
            fnames[4] = 'PHONE';
            ftypes[4] = 'phone';
            fnames[5] = 'BIRTHDAY';
            ftypes[5] = 'birthday';
        }(jQuery));
        var $mcj = jQuery.noConflict(true);
    </script>
</div></div>
            <div class="site-footer__col">
                <h3 class="site-footer__social-heading">
                    Connect With Us
                </h3>
                <div class="site-footer__social">
                    <a href="https://www.linkedin.com/company/secariolabs" class="site-footer__social-item" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true" viewBox="0 0 24 24"><path d="M19.7 3H4.3A1.3 1.3 0 0 0 3 4.3v15.4A1.3 1.3 0 0 0 4.3 21h15.4a1.3 1.3 0 0 0 1.3-1.3V4.3A1.3 1.3 0 0 0 19.7 3zM8.339 18.338H5.667v-8.59h2.672v8.59zM7.004 8.574a1.548 1.548 0 1 1-.002-3.096 1.548 1.548 0 0 1 .002 3.096zm11.335 9.764H15.67v-4.177c0-.996-.017-2.278-1.387-2.278-1.389 0-1.601 1.086-1.601 2.206v4.249h-2.667v-8.59h2.559v1.174h.037c.356-.675 1.227-1.387 2.526-1.387 2.703 0 3.203 1.779 3.203 4.092v4.711z"/></svg></a>
                    <a href="https:/x.com/SecarioLabs" class="site-footer__social-item" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865z"/></svg></a>
                    <a href="mailto:info@secariolabs.com" class="site-footer__social-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true" viewBox="0 0 24 24"><path d="M19 5H5c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm.5 12c0 .3-.2.5-.5.5H5c-.3 0-.5-.2-.5-.5V9.8l7.5 5.6 7.5-5.6V17zm0-9.1L12 13.6 4.5 7.9V7c0-.3.2-.5.5-.5h14c.3 0 .5.2.5.5v.9z"/></svg></a>
                    
                </div>
            </div>
        </div>

        <div class="site-footer__bottom">
            <span class="site-footer__bottom-item">All content © 2024 Secario Labs
                    </span><a class="site-footer__bottom-item site-footer__link" href="/privacy-policy/">Privacy Policy</a><a class="site-footer__bottom-item site-footer__link" href="/modern-slavery-policy/">Modern Slavery Policy</a><a class="site-footer__bottom-item site-footer__link" href="/contact/">Contact</a>
        </div>

    </div>
</footer><div id="modal" class="lightbox modal opacity-0 z_-10" data-i_frame="https://outlook.office365.com/owa/calendar/SecarioLabs@secariolabs.com/bookings/">
    <div class="modal__container">
        <div class="modal__content-container">
            <iframe src='' width='100%' height='100%' scrolling='yes' style='border:0'></iframe>
        </div>
        <svg id="close-modal-control" class="lightbox__close modal__close" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>
    </div>
</div><script src="/assets/js/slidetoggle.js"></script><script src="/assets/js/prism.js"></script><script src="/assets/js/scripts.js"></script><script>function handle_lightbox(figure_elements, element_type){

    const lightbox = document.getElementById('lightbox');
    const lightbox_img = lightbox.querySelector('img');
    const lightbox_caption = lightbox.querySelector('figcaption');
    const figures = document.querySelectorAll(figure_elements);
    const the_figure = document.getElementById('lightbox-figure');
    const close_control = document.getElementById('close-lightbox-control');
    const the_body = document.querySelector('body');

    let the_img;
    let the_caption = '';
    
    function open_figure(e){
        const $this = e.currentTarget;

        if(element_type === 'figure'){
            the_img = $this.querySelector('img');
            if($this.querySelector('figcaption')){
                the_caption = $this.querySelector('figcaption').innerHTML;
                lightbox_caption.classList.add('py-0_5rem');
                lightbox_caption.classList.add('px-1rem');
            } else {
                the_caption = '';
            }

        } else if(element_type === 'img'){
            the_img = $this;
        }

        const the_src = the_img.src;

        the_body.classList.add('no-scroll');

        lightbox_img.src = the_src;
        lightbox_caption.innerHTML = the_caption;

        lightbox.classList.remove('z_-10');
        lightbox.classList.remove('opacity-0');
        lightbox.classList.add('opacity-1');

        the_figure.classList.add('translate-y-0');
    }
    
    function close_figure(){
        lightbox_img.src = '';
        lightbox_caption.innerHTML = '';

        the_body.classList.remove('no-scroll');

        lightbox_caption.classList.remove('py-0_5rem');
        lightbox_caption.classList.remove('px-1rem');

        the_figure.classList.remove('translate-y-0');

        lightbox.classList.remove('opacity-1');
        lightbox.classList.add('opacity-0');
        lightbox.classList.add('z_-10');
    }

    figures.forEach(function(el){
        el.addEventListener('click', open_figure);
    });

    close_control.addEventListener('click', close_figure);

    document.addEventListener('click', function(e){
        if(e.target.id === 'lightbox'){
            close_figure();
        }
    });

    window.addEventListener('keydown', keyPress);
    
    function keyPress (e) {
        if(e.key === "Escape") {
            close_figure();
        }
    }

}handle_lightbox('article.post p:has(img:only-of-type) img', 'img');
    </script><script>function handle_modal(){

    const modal = document.getElementById('modal');
    const the_container = modal.querySelector('.modal__container');
    const close_control = document.getElementById('close-modal-control');
    const the_body = document.querySelector('body');
    const iframe_url = modal.dataset.i_frame;
    const the_iframe = modal.querySelector('iframe');
    
    function open_modal(){

        the_iframe.src = iframe_url;

        the_body.classList.add('no-scroll');

        modal.classList.remove('z_-10');
        modal.classList.remove('opacity-0');
        modal.classList.add('opacity-1');

        the_container.classList.add('translate-y-0');
    }
    
    function close_modal(){

        the_iframe.src = '';
        
        the_body.classList.remove('no-scroll');

        the_container.classList.remove('translate-y-0');

        modal.classList.remove('opacity-1');
        modal.classList.add('opacity-0');
        modal.classList.add('z_-10');
    }

    close_control.addEventListener('click', close_modal);

    document.addEventListener('click', function(e){
        if(e.target.id === 'modal'){
            close_modal();
        }
    });

    window.addEventListener('keydown', keyPress);
    
    function keyPress (e) {
        if(e.key === "Escape") {
            close_modal();
        }
    }

    document.querySelectorAll('[data-open-modal]').forEach(function(el){
        el.addEventListener('click', function(e){
            e.preventDefault();
            open_modal();
        });
    });

}

handle_modal()</script></body>

</html>
