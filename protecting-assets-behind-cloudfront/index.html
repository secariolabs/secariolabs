<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/css/main.css" /><title>Protecting Assets Behind CloudFront - Secario Labs</title>
  <meta
    name="description"
    content="One of the most common ways of bypassing a Web Application Firewall (WAF) involves finding out the backend servers’ address and connecting to it directly. An IP can be leaked in many ways, including DNS history, HTTP headers, cookies, virtual host routing with shared infrastructure, stack traces leaking source code,..."
  /><link
    rel="canonical"
    href="https://secariolabs.github.io/protecting-assets-behind-cloudfront/"
  /><link rel="icon" type="image/png" href="/assets/images/favicon/favicon-96x96--white.png" sizes="96x96" media="(prefers-color-scheme: dark)">
<link rel="icon" type="image/svg+xml" href="/assets/images/favicon/favicon--white.svg" media="(prefers-color-scheme: dark)">
<link rel="icon" type="image/png" href="/assets/images/favicon/favicon-96x96.png" sizes="96x96" media="(prefers-color-scheme: light)">
<link rel="icon" type="image/svg+xml" href="/assets/images/favicon/favicon.svg" media="(prefers-color-scheme: light)">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon/apple-touch-icon.png">
<meta name="apple-mobile-web-app-title" content="SecarioLabs">
<link rel="manifest" href="/site.webmanifest"><meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@SecarioLabs" />
<meta name="twitter:title" content="Protecting Assets Behind CloudFront" />
<meta name="twitter:description" content="One of the most common ways of bypassing a Web Application Firewall (WAF) involves finding out the backend servers’ address and connecting to it directly. An IP can be leaked in many ways, including DNS history, HTTP headers, cookies, virtual host routing with shared infrastructure, stack traces leaking source code,..." />
<meta name="twitter:image" content="https://secariolabs.github.io/assets/images/posts/depositphotos_56589681-stock-photo-business-overcomes-obstacles-applying-different.webp" />

<meta property="og:type" content="article" />
<meta property="og:title" content="Protecting Assets Behind CloudFront" />
<meta property="og:description" content="One of the most common ways of bypassing a Web Application Firewall (WAF) involves finding out the backend servers’ address and connecting to it directly. An IP can be leaked in many ways, including DNS history, HTTP headers, cookies, virtual host routing with shared infrastructure, stack traces leaking source code,..." />
<meta property="og:url" content="https://secariolabs.github.io/protecting-assets-behind-cloudfront/" />
<meta property="og:image" content="https://secariolabs.github.io/assets/images/posts/depositphotos_56589681-stock-photo-business-overcomes-obstacles-applying-different.webp" />
<link type="application/atom+xml" rel="alternate" href="https://secariolabs.github.io/feed.xml" title="Your awesome title" /></head>
<body data-prismjs-copy='' data-prismjs-copy-success=''><header  id="site-header"  class="site-header"><div class="banner hidden" id="banner">
    <div class="container container--xl">
        <p class="banner__title">
            <strong>We’ll beat any Web Application Penetration Test Quote You've Received <em>By 15%!</em></strong>
        </p>
        <p><a class="text-muted text-xs" href="/terms-and-conditions/">
                    Terms and coditions apply
                </a></p>
    </div><div class="banner__tag">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="#921F20" viewBox="0 0 100 100"><path d="M61.223 61.836c0 4.492-6.734 4.492-6.734 0 0-4.488 6.734-4.488 6.734 0M45.512 46.223c0 4.492-6.734 4.492-6.734 0 0-4.488 6.734-4.488 6.734 0"/><path d="m27.551 85.203 21.328-12.961c.203-.203.715-.203 1.02-.203.203 0 .406 0 .613.203L71.43 85.203v-53.57H27.55zm30.305-16.938a6.403 6.403 0 0 1-6.43-6.43c0-3.57 2.856-6.43 6.43-6.43 3.57 0 6.43 2.856 6.43 6.43 0 3.57-2.856 6.43-6.43 6.43zm4.695-26.836a1.601 1.601 0 0 1 0 2.246L40.305 65.917a1.578 1.578 0 0 1-2.144.102l-.102-.102a1.69 1.69 0 0 1 0-2.144l22.348-22.348a1.695 1.695 0 0 1 2.145.004zm-20.406-1.633c3.57 0 6.43 2.856 6.43 6.43 0 3.57-2.856 6.43-6.43 6.43-3.57-.102-6.328-2.856-6.43-6.43a6.4 6.4 0 0 1 6.43-6.43zM27.551 15.305H71.43v13.266H27.551z"/></svg>
        </div><button class="banner__close" id="close-banner">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon icon-tabler icons-tabler-outline icon-tabler-x" viewBox="0 0 24 24"><path stroke="none" d="M0 0h24v24H0z"/><path d="M18 6 6 18M6 6l12 12"/></svg>
    </button>
</div><nav id="site-nav" class="site-nav">
        <div class="container container--xl">
            <a href="/" class="site-nav__logo-link">
                <img class="site-nav__logo" src="/assets/images/secario-labs-logo.png" alt="Secario Labs logo" width="462" height="58">
            </a>

            <ul class="site-nav__items" id="nav">
                
                    <li class="site-nav__item"><a href="/about-us" class="site-nav__link">About Us</a></li>
                
                    <li class="site-nav__item"><a href="/services/" class="site-nav__link">Services</a></li>
                
                    <li class="site-nav__item"><a href="/defence/" class="site-nav__link">Defence</a></li>
                
                    <li class="site-nav__item"><a href="/blog/" class="site-nav__link site-nav__link--active">Blog</a></li>
                
                    <li class="site-nav__item"><button class="btn btn--md btn--light uppercase" data-open-modal>Book a call</button></li>
                
            </ul>

            <button class="burger" id="menu-btn"><svg width="32" height="32">
    <rect id="line1" y="8" width="32" height="2"></rect>
    <rect id="line2" y="16" width="32" height="2"></rect>
    <rect id="line3" y="24" width="32" height="2"></rect>
</svg></button>
        </div>
    </nav>

</header><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-ffffff-1">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 1"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 1"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 1"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-4">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-000000-ffffff-5">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0 1"></feFuncR>
        <feFuncG type="table" tableValues="0 1"></feFuncG>
        <feFuncB type="table" tableValues="0 1"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-c93b3b-ffffff-7">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.78823529411765 1"></feFuncR>
        <feFuncG type="table" tableValues="0.23137254901961 1"></feFuncG>
        <feFuncB type="table" tableValues="0.23137254901961 1"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-1">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-2">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg>

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 0 0" width="0" height="0" focusable="false" role="none" style="visibility: hidden; position: absolute; left: -9999px; overflow: hidden;">
  <defs>
    <filter id="duotone-1a1a1a-c93b3b-3">
      <feColorMatrix color-interpolation-filters="sRGB" type="matrix" values=" .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 .299 .587 .114 0 0 "></feColorMatrix>
      <feComponentTransfer color-interpolation-filters="sRGB">
        <feFuncR type="table" tableValues="0.10196078431373 0.78823529411765"></feFuncR>
        <feFuncG type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncG>
        <feFuncB type="table" tableValues="0.10196078431373 0.23137254901961"></feFuncB>
        <feFuncA type="table" tableValues="1 1"></feFuncA>
      </feComponentTransfer>
      <feComposite in2="SourceGraphic" operator="in"></feComposite>
    </filter>
  </defs>
</svg><main aria-label="Content">
      <section class="hero hero--page hero--post"  style="background-image: linear-gradient(0deg, rgba(0, 0, 0, 0.6) 0%,
  rgba(0, 0, 0, 0.7) 100%), url(/assets/images/posts/depositphotos_56589681-stock-photo-business-overcomes-obstacles-applying-different.webp);" >

  <div class="container container--sm">
    <h1 class="hero__heading hero__heading--page hero__heading--post">Protecting Assets Behind CloudFront</h1><div class="blog__teaser-meta">
    <div class="blog__teaser-date-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24"><path d="M4 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7zM16 3v4M8 3v4M4 11h16M7 14h.013M10.01 14h.005M13.01 14h.005M16.015 14h.005M13.015 17h.005M7.01 17h.005M10.01 17h.005"/></svg>
        <time datetime="2023-04-09T12:24:47+00:00" class="span blog__teaser-date text-sm">
            April  9, 2023
        </time>
    </div><div class="blog__teaser-tags-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24"><path d="M3 8v4.172a2 2 0 0 0 .586 1.414l5.71 5.71a2.41 2.41 0 0 0 3.408 0l3.592-3.592a2.41 2.41 0 0 0 0-3.408l-5.71-5.71A2 2 0 0 0 9.172 6H5a2 2 0 0 0-2 2z"/><path d="m18 19 1.592-1.592a4.82 4.82 0 0 0 0-6.816L15 6M7 10h-.01"/></svg>
            <div class="blog__teaser-tags">
                <span class="blog__teaser-tag text-sm text-light">aws</span>, <span class="blog__teaser-tag text-sm text-light">cloudfront</span>, <span class="blog__teaser-tag text-sm text-light">waf</span>
            </div>
        </div></div></div>
</section><section class="post-wrapper">
  <section class="section section--page section--post">
    <div class="container container--sm">
      <div class="post__bc text-muted">
        <a
          class="post__bc-item text-muted underline"
          href="/"
          >Home</a
        >
        »
        <a
          class="post__bc-item text-muted underline"
          href="/blog/"
          >Blog</a
        >
        »
        <strong class="post__bc-item text-muted post__bc-item--active"
          >Protecting Assets Behind CloudFront</strong
        >
      </div>

      <article class="post"><p>One of the most common ways of bypassing a Web Application Firewall (WAF) involves finding out the backend servers’ address and connecting to it directly. An IP can be leaked in many ways, including DNS history, HTTP headers, cookies, virtual host routing with shared infrastructure, stack traces leaking source code, successful server-side request forgery attacks, even sometimes you can find it in the JavaScript source map. And assuming you locate the IP you can then directly reach the server and bypass all the protections and logging that a WAF provides.</p>

<p>Very often during engagements, we assess web applications positioned behind AWS CloudFront, which by default is not a WAF but a Content Delivery Network (CDN) designed to speed up the loading time of a website by caching static files and delivering them quickly thanks to the many nodes CloudFront has all over the world. Even though CloudFront by default does not operate as a WAF, it does provide <a href="https://docs.aws.amazon.com/waf/latest/developerguide/cloudfront-features.html">an intuitive way</a> of adding WAF rules which can then be applied on each request passing through the service. More often than not, we see them being used. The rules can either be a managed subscription by a third-party vendor (e.g., F5) or they can be inline, written manually by the application owner.</p>

<p>As AWS does not provide a simple way for developers to limit requests to their web applications (EC2) to be coming only from CloudFront, very often people try to improvise with different ways of enforcing the chain. For example, they use <strong>tokens</strong> – <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/add-origin-custom-headers.html">adding a custom HTTP header</a> with a unique value which is sent with all requests from CloudFront and then verified on the web application server. While this is a strict technique relying on a shared secret, there are both security concerns with the secret leaking (when a header is reflected in the response), and it also adds a very large complexity as there must be an additional mechanism that can rotate the secret. Rotation involves changes to AWS resources and to the application logic, not to mention the potential downtime if these actions are not synchronized fully.</p>

<p>A lesser-known technique that <a href="https://aws.amazon.com/blogs/security/automatically-update-security-groups-for-amazon-cloudfront-ip-ranges-using-aws-lambda/">AWS has suggested</a> <a href="https://aws.amazon.com/blogs/security/how-to-automatically-update-your-security-groups-for-amazon-cloudfront-and-aws-waf-by-using-aws-lambda/">over the years</a> is to restrict access based on an IP address. While this sounds very much like what Cloudflare has as its default recommendation, with CloudFront things are a bit more complicated as AWS does not have a constant strict address pool for this service, but rather they rotate IP addresses frequently — meaning that if you don’t update the firewall immediately when a change occurs, you risk both downtimes as new requests could be coming from a non-approved IP address and attacks from servers/services that now have an IP address which was previously associated with CloudFront.</p>

<p>In this article we will build a lab in which we will 1) create a simple application behind CloudFront, 2) place some WAF rules and demonstrate the weakness, and 3) configure an IP-based restriction that should protect the end system.</p>

<h2 id="setting-up-the-environment">Setting up the Environment</h2>

<p>For this example, we can create a simple web server in AWS with a <em>public</em> and a <em>private</em> page which we will then try to protect with WAF rules on CloudFront.</p>

<h3 id="creating-the-web-server">Creating the Web Server</h3>

<p>The first thing we need to do is create a security group with an inbound “allow all” rule for port 80:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws ec2 create-security-group<span class="se">\</span>
	<span class="nt">--group-name</span> ExampleWebsite<span class="se">\</span>
	<span class="nt">--description</span> <span class="s2">"Example Website for testing CloudFront with WAF rules"</span>
<span class="o">{</span>
    <span class="s2">"GroupId"</span>: <span class="s2">"sg-0de46ea030c72802c"</span>
<span class="o">}</span>
<span class="nv">$ </span>aws ec2 authorize-security-group-ingress<span class="se">\</span>
	<span class="nt">--group-id</span> sg-0de46ea030c72802c<span class="se">\</span>
	<span class="nt">--protocol</span> tcp <span class="nt">--port</span> 80 <span class="nt">--cidr</span> 0.0.0.0/0
</code></pre></div></div>

<p>Next, optionally, we can quickly create an SSH key to use for the new system:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws ec2 create-key-pair<span class="se">\</span>
	<span class="nt">--key-name</span> MyKeyPair<span class="se">\</span>
	<span class="nt">--query</span> <span class="s1">'KeyMaterial'</span><span class="se">\</span>
	<span class="nt">--output</span> text <span class="o">&gt;</span> MyKeyPair.pem
</code></pre></div></div>

<p>Finally, we will need a simple bash script <code class="language-plaintext highlighter-rouge">script.sh</code> to run at build time on the web server:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

yum update <span class="nt">-y</span>

yum <span class="nb">install</span> <span class="nt">-y</span> httpd.x86_64

systemctl start httpd.service

<span class="nb">echo</span> <span class="s2">"This is a public page"</span>  <span class="o">&gt;</span> /var/www/html/index.html

<span class="nb">echo</span> <span class="s2">"secret"</span>  <span class="o">&gt;</span> /var/www/html/private.html
</code></pre></div></div>

<p>With these prerequisites out of the way, now is time to just build the web server:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws ec2 run-instances<span class="se">\</span>
	<span class="nt">--image-id</span> ami-0ad97c80f2dfe623b<span class="se">\</span>
	<span class="nt">--instance-type</span> t2.nano<span class="se">\</span>
	<span class="nt">--user-data</span> file://script.sh<span class="se">\</span>
	<span class="nt">--security-group-ids</span> sg-0de46ea030c72802c<span class="se">\</span>
	<span class="nt">--key-name</span> MyKeyPair
<span class="o">{</span>
    <span class="s2">"Groups"</span>: <span class="o">[]</span>,
    <span class="s2">"Instances"</span>: <span class="o">[{</span>
        <span class="s2">"AmiLaunchIndex"</span>: 0,
        <span class="s2">"ImageId"</span>: <span class="s2">"ami-0ad97c80f2dfe623b"</span>,
        <span class="s2">"InstanceId"</span>: <span class="s2">"i-0af0b1290214d5d95"</span>,
...
</code></pre></div></div>

<p>A couple of minutes later, it is possible to get the public IP of the system with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws ec2 describe-instances<span class="se">\</span>
	<span class="nt">--instance-ids</span> i-0af0b1290214d5d95<span class="se">\</span>
	<span class="nt">--query</span> <span class="s1">'Reservations[*].Instances[*].PublicIpAddress'</span><span class="se">\</span>
	<span class="nt">--output</span> text
18.133.242.145
</code></pre></div></div>

<p>Now is time to check the environment; we can quickly see that the server is up and the pages are there:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://18.133.242.145
This is a public page
<span class="nv">$ </span>curl http://18.133.242.145/private.html
secret
</code></pre></div></div>

<h3 id="setting-up-route-53">Setting up Route 53</h3>

<p>To set up CloudFront, we will need to first create a DNS record for the web server. We already a hosted zone configured in the AWS account which we can use, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws route53 list-hosted-zones
<span class="o">{</span>
    <span class="s2">"HostedZones"</span>: <span class="o">[{</span>
        <span class="s2">"Id"</span>: <span class="s2">"/hostedzone/Z0520503IHM7MMFXXXXX"</span>,
        <span class="s2">"Name"</span>: <span class="s2">"secariolabs.com."</span>,
...

</code></pre></div></div>

<p>To create an <code class="language-plaintext highlighter-rouge">A</code> record mapping <code class="language-plaintext highlighter-rouge">private.demo.secariolabs.com</code> to the EC2 system, we will need the following <code class="language-plaintext highlighter-rouge">create-record.json</code> file:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">Comment</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Testing creating a record set</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">Changes</span><span class="dl">"</span><span class="p">:</span> <span class="p">[{</span>
    <span class="dl">"</span><span class="s2">Action</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">CREATE</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">ResourceRecordSet</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">Name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">private.demo.secariolabs.com</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">TTL</span><span class="dl">"</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">ResourceRecords</span><span class="dl">"</span><span class="p">:</span> <span class="p">[{</span>
        <span class="dl">"</span><span class="s2">Value</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">18.133.242.145</span><span class="dl">"</span>
      <span class="p">}]</span>
    <span class="p">}</span>
  <span class="p">}]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now is just a matter of making the request to Route 53, as shown below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws route53 change-resource-record-sets<span class="se">\</span>
	<span class="nt">--hosted-zone-id</span> <span class="s2">"/hostedzone/Z0520503IHM7MMFXXXXX"</span><span class="se">\</span>
	<span class="nt">--change-batch</span> file://create-record.json
</code></pre></div></div>

<p>A couple of seconds later you can check that the record is active:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws route53 get-change <span class="nt">--id</span> C018062338JPC4J7GN2I9
<span class="o">{</span>
    <span class="s2">"ChangeInfo"</span>: <span class="o">{</span>
        <span class="s2">"Id"</span>: <span class="s2">"/change/C018062338JPC4J7GN2I9"</span>,
        <span class="s2">"Status"</span>: <span class="s2">"INSYNC"</span>,
        <span class="s2">"SubmittedAt"</span>: <span class="s2">"2023-04-07T00:50:12.606000+00:00"</span>,
        <span class="s2">"Comment"</span>: <span class="s2">"Testing creating a record set"</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And we can confirm that the site is still accessible:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://private.demo.secariolabs.com
This is a public page
<span class="nv">$ </span>curl http://private.demo.secariolabs.com/private.html
secret
</code></pre></div></div>

<h3 id="setting-up-cloudfront">Setting up CloudFront</h3>

<p>The next step is to finally create the CloudFront distribution routing traffic to our website. To make the request to AWS we will need the following <code class="language-plaintext highlighter-rouge">distribution.json</code> file:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">CallerReference</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cf-cli-distribution</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">Comment</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Example Cloudfront Distribution</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">Origins</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">Quantity</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">Items</span><span class="dl">"</span><span class="p">:</span> <span class="p">[{</span>
      <span class="dl">"</span><span class="s2">Id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">private.demo.secariolabs.com</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">DomainName</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">private.demo.secariolabs.com</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">CustomOriginConfig</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">HTTPPort</span><span class="dl">"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">HTTPSPort</span><span class="dl">"</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">OriginProtocolPolicy</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">http-only</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">OriginSslProtocols</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">Quantity</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">Items</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">TLSv1.2</span><span class="dl">"</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}]</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">DefaultCacheBehavior</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">TargetOriginId</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">private.demo.secariolabs.com</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">ViewerProtocolPolicy</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">redirect-to-https</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">AllowedMethods</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">Quantity</span><span class="dl">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">Items</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">HEAD</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">],</span>
      <span class="dl">"</span><span class="s2">CachedMethods</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">Quantity</span><span class="dl">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">Items</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">HEAD</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">CachePolicyId</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">4135ea2d-6df8-44a3-9df3-4b5a84be39ad</span><span class="dl">"</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">Enabled</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And the final command to create it looks as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws cloudfront create-distribution <span class="nt">--distribution-config</span> file://distribution.json
<span class="o">{</span>
    <span class="s2">"Location"</span>: <span class="s2">"https://cloudfront.amazonaws.com/2020-05-31/distribution/E3OSJ4978QOTZ2"</span>,
    <span class="s2">"ETag"</span>: <span class="s2">"E1Y4BASGKG03MO"</span>,
    <span class="s2">"Distribution"</span>: <span class="o">{</span>
        <span class="s2">"Id"</span>: <span class="s2">"E3OSJ4978QOTZ2"</span>,
        <span class="s2">"ARN"</span>: <span class="s2">"arn:aws:cloudfront::9536171XXXXX:distribution/E3OSJ4978QOTZ2"</span>,
        <span class="s2">"Status"</span>: <span class="s2">"InProgress"</span>,
        <span class="s2">"LastModifiedTime"</span>: <span class="s2">"2023-04-07T01:29:11.959000+00:00"</span>,
        <span class="s2">"InProgressInvalidationBatches"</span>: 0,
        <span class="s2">"DomainName"</span>: <span class="s2">"d1489et6zspdol.cloudfront.net"</span>,
...
</code></pre></div></div>

<p>A couple of minutes later we can go ahead and check the connection to the site:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://d1489et6zspdol.cloudfront.net <span class="nt">-L</span>
This is a public page
<span class="nv">$ </span>curl http://d1489et6zspdol.cloudfront.net/private.html <span class="nt">-L</span>
secret
</code></pre></div></div>

<h3 id="adding-a-waf-rule-to-cloudfront">Adding a WAF Rule to CloudFront</h3>

<p>The next task for us is to create a WAF rule which we can use to protect everything going to <code class="language-plaintext highlighter-rouge">/private*</code>. The following <code class="language-plaintext highlighter-rouge">waf-rule.json</code> file was created for this purpose (note that <code class="language-plaintext highlighter-rouge">L3ByaXZhdGU=</code> is <code class="language-plaintext highlighter-rouge">/private</code>):</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[{</span>
  <span class="dl">"</span><span class="s2">Name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">basic-rule</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">Priority</span><span class="dl">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">Statement</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">ByteMatchStatement</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">SearchString</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">L3ByaXZhdGU=</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">FieldToMatch</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">UriPath</span><span class="dl">"</span><span class="p">:</span> <span class="p">{}</span>
      <span class="p">},</span>
      <span class="dl">"</span><span class="s2">TextTransformations</span><span class="dl">"</span><span class="p">:</span> <span class="p">[{</span>
        <span class="dl">"</span><span class="s2">Priority</span><span class="dl">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">NORMALIZE_PATH</span><span class="dl">"</span>
      <span class="p">}],</span>
      <span class="dl">"</span><span class="s2">PositionalConstraint</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">STARTS_WITH</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">Action</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">Block</span><span class="dl">"</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">VisibilityConfig</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">SampledRequestsEnabled</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">CloudWatchMetricsEnabled</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">MetricName</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">basic-rule</span><span class="dl">"</span>
  <span class="p">}</span>
<span class="p">}]</span>
</code></pre></div></div>

<p>Time to create the rule, where you will notice it is specifically created for CloudFront and the <code class="language-plaintext highlighter-rouge">us-east-1</code> region even though our EC2 instance is in <code class="language-plaintext highlighter-rouge">eu-west-2</code>. The reason this is the case is because CloudFront only exists in <code class="language-plaintext highlighter-rouge">us-east-1</code> and the WAF rule(s) have to be in the same region, whereas because CloudFront maps to an external IP address, there is no strict requirement for the EC2 system to be in the same region.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws wafv2 create-web-acl<span class="se">\</span>
    <span class="nt">--name</span> TestWebAcl<span class="se">\</span>
    <span class="nt">--scope</span> CLOUDFRONT<span class="se">\</span>
    <span class="nt">--default-action</span> <span class="nv">Allow</span><span class="o">={}</span><span class="se">\</span>
    <span class="nt">--visibility-config</span> <span class="nv">SampledRequestsEnabled</span><span class="o">=</span><span class="nb">true</span>,CloudWatchMetricsEnabled<span class="o">=</span><span class="nb">true</span>,MetricName<span class="o">=</span>TestWebAclMetrics<span class="se">\</span>
    <span class="nt">--rules</span> file://waf-rule.json<span class="se">\</span>
    <span class="nt">--region</span> us-east-1
<span class="o">{</span>
    <span class="s2">"Summary"</span>: <span class="o">{</span>
        <span class="s2">"Name"</span>: <span class="s2">"TestWebAcl"</span>,
        <span class="s2">"Id"</span>: <span class="s2">"74941941-24b9-4b1e-b0c0-276a653aad85"</span>,
        <span class="s2">"Description"</span>: <span class="s2">""</span>,
        <span class="s2">"LockToken"</span>: <span class="s2">"ba596cac-bdc8-490f-af7c-1f4734c720f3"</span>,
        <span class="s2">"ARN"</span>: <span class="s2">"arn:aws:wafv2:us-east-1:9536171XXXXX:global/webacl/TestWebAcl/74941941-24b9-4b1e-b0c0-276a653aad85"</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>While the intuitive step at this moment would be to use <code class="language-plaintext highlighter-rouge">aws wafv2 associate-web-acl</code> this would not work. Applying WAF rules to CloudFront requires making updates to the configuration, rather than simply associating the rule. To make things even harder, AWS does not allow you to simply send an update with only the particular values you want to change, but rather you will need to download the configuration patch it and submit it again.</p>

<p>To Download the configuration file we can use the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws cloudfront get-distribution-config<span class="se">\</span>
	<span class="nt">--id</span> E3OSJ4978QOTZ2<span class="se">\</span>
	<span class="nt">--query</span> <span class="s2">"DistributionConfig"</span><span class="se">\</span>
	<span class="nt">--output</span> json <span class="o">&gt;</span> current-distribution.json
</code></pre></div></div>

<p>Next we can patch the <code class="language-plaintext highlighter-rouge">WebACLId</code> value to list the rule we want to be applied:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sed</span> <span class="s1">'/WebACLId/c\"WebACLId\":\"arn:aws:wafv2:us-east-1:9536171XXXXX:global/webacl/TestWebAcl/74941941-24b9-4b1e-b0c0-276a653aad85\",'</span> current-distribution.json <span class="o">&gt;</span> updated-distribution.json
</code></pre></div></div>

<p>Finally, we can make an update request, where you will notice we not only are passing the <code class="language-plaintext highlighter-rouge">DistributionId</code>, but also the <code class="language-plaintext highlighter-rouge">ETag</code> we received when we created the distribution.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws cloudfront update-distribution<span class="se">\</span>
	<span class="nt">--id</span> E3OSJ4978QOTZ2<span class="se">\</span>
	<span class="nt">--distribution-config</span> file://updated-distribution.json<span class="se">\</span>
	<span class="nt">--if-match</span> E1Y4BASGKG03MO
<span class="o">{</span>
    <span class="s2">"ETag"</span>: <span class="s2">"E2JUPVIBC3V15H"</span>,
    <span class="s2">"Distribution"</span>: <span class="o">{</span>
        <span class="s2">"Id"</span>: <span class="s2">"E3OSJ4978QOTZ2"</span>,
        <span class="s2">"ARN"</span>: <span class="s2">"arn:aws:cloudfront::9536171XXXXX:distribution/E3OSJ4978QOTZ2"</span>,
        <span class="s2">"Status"</span>: <span class="s2">"InProgress"</span>,
        <span class="s2">"LastModifiedTime"</span>: <span class="s2">"2023-04-07T02:26:50.622000+00:00"</span>,
        <span class="s2">"InProgressInvalidationBatches"</span>: 0,
        <span class="s2">"DomainName"</span>: <span class="s2">"d1489et6zspdol.cloudfront.net"</span>,
...
</code></pre></div></div>

<p>To make sure the rule is applied we can check the access to the pages:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl https://d1489et6zspdol.cloudfront.net
This is a public page
<span class="nv">$ </span>curl https://d1489et6zspdol.cloudfront.net/private.html
&lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="s2">"http://www.w3.org/TR/html4/loose.dtd"</span><span class="o">&gt;</span>
&lt;HTML&gt;&lt;HEAD&gt;&lt;META HTTP-EQUIV<span class="o">=</span><span class="s2">"Content-Type"</span> <span class="nv">CONTENT</span><span class="o">=</span><span class="s2">"text/html; charset=iso-8859-1"</span><span class="o">&gt;</span>
&lt;TITLE&gt;ERROR: The request could not be satisfied&lt;/TITLE&gt;
&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;403 ERROR&lt;/H1&gt;
&lt;H2&gt;The request could not be satisfied.&lt;/H2&gt;
&lt;HR noshade <span class="nv">size</span><span class="o">=</span><span class="s2">"1px"</span><span class="o">&gt;</span>
Request blocked.
We can<span class="s1">'t connect to the server for this app or website at this time. There might be too much traffic or a configuration error. Try again later, or contact the app or website owner.
&lt;BR clear="all"&gt;
If you provide content to customers through CloudFront, you can find steps to troubleshoot and help prevent this error by reviewing the CloudFront documentation.
&lt;BR clear="all"&gt;
&lt;HR noshade size="1px"&gt;
&lt;PRE&gt;
Generated by cloudfront (CloudFront)
Request ID: QGJDmdNqJJ6_zS3ALUczF-8NrM-HDKqTzNu-CZoppz6bi3nWv_cSIw==
&lt;/PRE&gt;
&lt;ADDRESS&gt;
&lt;/ADDRESS&gt;
&lt;/BODY&gt;&lt;/HTML&gt;
</span></code></pre></div></div>

<h2 id="strengthening-the-environment">Strengthening the Environment</h2>

<p>At this point, you will be right to notice that direct requests to <code class="language-plaintext highlighter-rouge">http://private.demo.secariolabs.com/private.html</code> would still be successful because in this case the WAF would not be applied. The traffic wouldn’t be passing through it but directly to the server.</p>

<h3 id="creating-a-custom-lambda">Creating a Custom Lambda</h3>

<p>To handle this, we can follow the recommendation from AWS and create our own Lambda function that pulls the latest list of IP addresses associated with CloudFront and updates the rules on the security group attached to our web server. In effect that would prevent unauthorized traffic and enforce a chain.</p>

<p>The Lambda will need to have the following <code class="language-plaintext highlighter-rouge">lambda_function.py</code> file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">boto3</span>
<span class="kn">import</span> <span class="n">urllib.request</span>
<span class="kn">import</span> <span class="n">hashlib</span>


<span class="n">INGRESS_PORTS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">80</span><span class="p">]</span>  <span class="c1"># but may as well be [80, 443] or just [443]
</span><span class="n">VPC_ID</span> <span class="o">=</span> <span class="sh">"</span><span class="s">vpc-032a791ded3139c0b</span><span class="sh">"</span>  <span class="c1"># change me
</span><span class="n">SECURITYGROUP_ID</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sg-0de46ea030c72802c</span><span class="sh">"</span>  <span class="c1"># change me
</span><span class="n">REGION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">eu-west-2</span><span class="sh">"</span>  <span class="c1"># change me
</span>
<span class="n">ec2_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="nf">client</span><span class="p">(</span><span class="sh">"</span><span class="s">ec2</span><span class="sh">"</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">REGION</span><span class="p">)</span>
<span class="n">ec2_resource</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="nf">resource</span><span class="p">(</span><span class="sh">"</span><span class="s">ec2</span><span class="sh">"</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">REGION</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># SNS message notification event when the ip ranges document is rotated
</span>    <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="sh">"</span><span class="s">Records</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">Sns</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">Message</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">urlopen</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">ip_ranges</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">read</span><span class="p">())</span>

    <span class="n">cf_ranges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">ip_ranges</span><span class="p">[</span><span class="sh">"</span><span class="s">prefixes</span><span class="sh">"</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">prefix</span><span class="p">[</span><span class="sh">"</span><span class="s">service</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">CLOUDFRONT</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">cf_ranges</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">prefix</span><span class="p">[</span><span class="sh">"</span><span class="s">ip_prefix</span><span class="sh">"</span><span class="p">])</span>

    <span class="n">rangeToUpdate</span> <span class="o">=</span> <span class="n">ec2_client</span><span class="p">.</span><span class="nf">describe_security_groups</span><span class="p">(</span><span class="n">GroupIds</span><span class="o">=</span><span class="p">[</span><span class="n">SECURITYGROUP_ID</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">rangeToUpdate</span><span class="p">[</span><span class="sh">"</span><span class="s">SecurityGroups</span><span class="sh">"</span><span class="p">]:</span>

        <span class="n">sgo</span> <span class="o">=</span> <span class="n">ec2_resource</span><span class="p">.</span><span class="nc">SecurityGroup</span><span class="p">(</span><span class="n">sg</span><span class="p">[</span><span class="sh">"</span><span class="s">GroupId</span><span class="sh">"</span><span class="p">])</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sgo</span><span class="p">.</span><span class="n">ip_permissions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sgo</span><span class="p">.</span><span class="nf">revoke_ingress</span><span class="p">(</span><span class="n">IpPermissions</span><span class="o">=</span><span class="n">sgo</span><span class="p">.</span><span class="n">ip_permissions</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">each_proto</span> <span class="ow">in</span> <span class="n">INGRESS_PORTS</span><span class="p">:</span>

            <span class="n">add_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">ToPort</span><span class="sh">"</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">each_proto</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">FromPort</span><span class="sh">"</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">each_proto</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">IpRanges</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span><span class="sh">"</span><span class="s">CidrIp</span><span class="sh">"</span><span class="p">:</span> <span class="nb">range</span><span class="p">}</span> <span class="k">for</span> <span class="nb">range</span> <span class="ow">in</span> <span class="n">cf_ranges</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">IpProtocol</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tcp</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">ec2_client</span><span class="p">.</span><span class="nf">authorize_security_group_ingress</span><span class="p">(</span>
                <span class="n">GroupId</span><span class="o">=</span><span class="n">sg</span><span class="p">[</span><span class="sh">"</span><span class="s">GroupId</span><span class="sh">"</span><span class="p">],</span> <span class="n">IpPermissions</span><span class="o">=</span><span class="p">[</span><span class="n">add_params</span><span class="p">]</span>
            <span class="p">)</span>

</code></pre></div></div>

<p>But before we can go ahead and create the Lambda function, we will need to 1) create a policy with the necessary permissions, and 2) a role we can attach the policy to.</p>

<p>Starting with the IAM policy, we will need the following <code class="language-plaintext highlighter-rouge">lambdarole.json</code> file:</p>

<p><em>Disclaimer: It is recommended to break down the policy into smaller statements and be specific about which resources it should apply to. This is a simple proof-of-concept.</em></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">Version</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2012-10-17</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">Statement</span><span class="dl">"</span><span class="p">:</span> <span class="p">[{</span>
    <span class="dl">"</span><span class="s2">Sid</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">CloudWatchPermissions</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">Effect</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Allow</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">Action</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
      <span class="dl">"</span><span class="s2">logs:CreateLogGroup</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">logs:CreateLogStream</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">logs:PutLogEvents</span><span class="dl">"</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">Resource</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">arn:aws:logs:*:*:*</span><span class="dl">"</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">Sid</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">EC2Permissions</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">Effect</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Allow</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">Action</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
      <span class="dl">"</span><span class="s2">ec2:DescribeSecurityGroups</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">ec2:AuthorizeSecurityGroupIngress</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">ec2:RevokeSecurityGroupIngress</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">ec2:DescribeVpcs</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">ec2:ModifyNetworkInterfaceAttribute</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">ec2:DescribeNetworkInterfaces</span><span class="dl">"</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">Resource</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">arn:aws:ec2:*:*:*</span><span class="dl">"</span>
  <span class="p">}]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The policy creation can be done with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws iam create-policy<span class="se">\</span>
	<span class="nt">--policy-name</span> LambdaPolicy<span class="se">\</span>
	<span class="nt">--policy-document</span> file://lambdarole.json
<span class="o">{</span>
    <span class="s2">"Policy"</span>: <span class="o">{</span>
        <span class="s2">"PolicyName"</span>: <span class="s2">"LambdaPolicy"</span>,
        <span class="s2">"PolicyId"</span>: <span class="s2">"ANPA54CACFZZNFOYOE5ZW"</span>,
        <span class="s2">"Arn"</span>: <span class="s2">"arn:aws:iam::9536171XXXXX:policy/LambdaPolicy"</span>,
...
</code></pre></div></div>

<p>Next, we will need to create a Lambda-based IAM role and then attach to it the policy we just created. For the role we will need the following <code class="language-plaintext highlighter-rouge">basepolicy.json</code> file:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">Version</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2012-10-17</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">Statement</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">Effect</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Allow</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">Principal</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">Service</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">lambda.amazonaws.com</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">Action</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">sts:AssumeRole</span><span class="dl">"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The commands needed to create the role and attach the policy look as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws iam create-role<span class="se">\</span>
	<span class="nt">--role-name</span> LambdaExecutionRole<span class="se">\</span>
	<span class="nt">--assume-role-policy-document</span>  file://basepolicy.json
<span class="o">{</span>
    <span class="s2">"Role"</span>: <span class="o">{</span>
        <span class="s2">"Path"</span>: <span class="s2">"/"</span>,
        <span class="s2">"RoleName"</span>: <span class="s2">"LambdaRole"</span>,
        <span class="s2">"RoleId"</span>: <span class="s2">"AROA54CACFZZMTBSYMFCL"</span>,
        <span class="s2">"Arn"</span>: <span class="s2">"arn:aws:iam::9536171XXXXX:role/LambdaRole"</span>,
...
<span class="nv">$ </span>aws iam attach-role-policy<span class="se">\</span>
	<span class="nt">--role-name</span> LambdaRole<span class="se">\</span>
	<span class="nt">--policy-arn</span> <span class="s2">"arn:aws:iam::9536171XXXXX:policy/LambdaPolicy"</span>
</code></pre></div></div>

<p>Finally, we can archive the Lambda function we wrote and upload it to AWS:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>zip code.zip lambda_function.py
<span class="nv">$ </span>aws lambda create-function<span class="se">\</span>
	<span class="nt">--function-name</span> UpdatingSGForCloudFront<span class="se">\</span>
	<span class="nt">--runtime</span> python3.9<span class="se">\</span>
	<span class="nt">--zip-file</span> fileb://code.zip<span class="se">\</span>
	<span class="nt">--handler</span> lambda_function.lambda_handler<span class="se">\</span>
	<span class="nt">--role</span> arn:aws:iam::9536171XXXXX:role/LambdaExecutionRole<span class="se">\</span>
	<span class="nt">--region</span> eu-west-2
<span class="o">{</span>
    <span class="s2">"FunctionName"</span>: <span class="s2">"UpdatingSGForCloudFront"</span>,
    <span class="s2">"FunctionArn"</span>: <span class="s2">"arn:aws:lambda:eu-west-2:9536171XXXXX:function:UpdatingSGForCloudFront"</span>,
...
</code></pre></div></div>

<h3 id="testing-the-lambda-function">Testing the Lambda Function</h3>

<p>Before we can test the Lambda function it is important to note that on average there are around 145-6 IP addresses associated with CloudFront, and because we will need to list each one of these IPs as a separate rule in the security group, we will hit the default quota on AWS for the number of <em>Inbound or outbound rules per security group</em>. So, it is important before we move forward to increase our quota with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws service-quotas request-service-quota-increase<span class="se">\</span>
    <span class="nt">--service-code</span> vpc<span class="se">\</span>
    <span class="nt">--quota-code</span> L-0EA8095F<span class="se">\</span>
    <span class="nt">--desired-value</span> 160
</code></pre></div></div>

<p>Keep in mind that the previous command could take an hour (or even more) to go into effect. But once ready, we can then use test input (file <code class="language-plaintext highlighter-rouge">lambdatestinput.json</code>) to run the command and see how it will behave. You will notice that this input appears to be an SNS event message, which is intentional. AWS has a public SNS topic that they use to notify whenever there is a change with the IP address association, so at the very end of our setup, we will subscribe to it, but before that, we will use it as test input:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">Records</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="dl">"</span><span class="s2">EventVersion</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.0</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">EventSubscriptionArn</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">arn:aws:sns:EXAMPLE</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">EventSource</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">aws:sns</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">Sns</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">SignatureVersion</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">Timestamp</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1970-01-01T00:00:00.000Z</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">Signature</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">EXAMPLE</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">SigningCertUrl</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">EXAMPLE</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">MessageId</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">95df01b4-ee98-5cb9-9903-4c221d41eb5e</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">Message</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">{</span><span class="se">\"</span><span class="s2">create-time</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">yyyy-mm-ddThh:mm:ss+00:00</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">synctoken</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">0123456789</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">md5</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">7fd59f5c7f5cf643036cbd4443ad3e4b</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">url</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">https://ip-ranges.amazonaws.com/ip-ranges.json</span><span class="se">\"</span><span class="s2">}</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Notification</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">UnsubscribeUrl</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">EXAMPLE</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">TopicArn</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">arn:aws:sns:EXAMPLE</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">Subject</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">TestInvoke</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To invoke the Lambda function with the test input we can use the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws lambda invoke<span class="se">\</span>
	<span class="nt">--function-name</span> UpdatingSGForCloudFront<span class="se">\</span>
	<span class="nt">--payload</span> fileb://lambdatestinput.json<span class="se">\</span>
	outputfile.txt
<span class="o">{</span>
    <span class="s2">"StatusCode"</span>: 200,
    <span class="s2">"ExecutedVersion"</span>: <span class="s2">"</span><span class="nv">$LATEST</span><span class="s2">"</span>
<span class="o">}</span>
<span class="nv">$ </span><span class="nb">cat </span>outputfile.txt
null
</code></pre></div></div>

<p>And to verify that indeed the rules have been created, we can check how many rules our security group now has:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws ec2 describe-security-group-rules<span class="se">\</span>
	<span class="nt">--filter</span> <span class="nv">Name</span><span class="o">=</span><span class="s2">"group-id"</span>,Values<span class="o">=</span><span class="s2">"sg-0de46ea030c72802c"</span> |<span class="se">\</span>
	jq <span class="nt">-r</span> <span class="s1">'.SecurityGroupRules | length'</span>
146
</code></pre></div></div>

<p>The final check is to confirm that we can’t reach the EC2 instance directly:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://private.demo.secariolabs.com <span class="nt">--connect-timeout</span> 2
curl: <span class="o">(</span>28<span class="o">)</span> Failed to connect to private.demo.secariolabs.com port 80 after 2001 ms: Timeout was reached
</code></pre></div></div>

<h3 id="subscribing-to-the-relevant-sns-topic">Subscribing to the Relevant SNS Topic</h3>

<p>To ensure resilience and constant synchronization with the changes to the IP address space of CloudFront we can subscribe to the <code class="language-plaintext highlighter-rouge">AmazonIpSpaceChanged</code> public SNS topic and leave it alone.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>aws sns subscribe<span class="se">\</span>
	<span class="nt">--topic-arn</span> <span class="s2">"arn:aws:sns:us-east-1:806199016981:AmazonIpSpaceChanged"</span><span class="se">\</span>
	<span class="nt">--region</span> us-east-1<span class="se">\</span>
	<span class="nt">--protocol</span> lambda<span class="se">\</span>
	<span class="nt">--notification-endpoint</span> <span class="s2">"arn:aws:lambda:eu-west-2:9536171XXXXX:function:UpdatingSGForCloudFront"</span>
<span class="nv">$ </span>aws lambda add-permission<span class="se">\</span>
	<span class="nt">--function-name</span> <span class="s2">"arn:aws:lambda:eu-west-2:9536171XXXXX:function:UpdatingSGForCloudFront"</span><span class="se">\</span>
	<span class="nt">--statement-id</span> lambda-sns-trigger<span class="se">\</span>
	<span class="nt">--region</span> eu-west-2<span class="se">\</span>
	<span class="nt">--action</span> lambda:InvokeFunction<span class="se">\</span>
	<span class="nt">--principal</span> sns.amazonaws.com<span class="se">\</span>
	<span class="nt">--source-arn</span> <span class="s2">"arn:aws:sns:us-east-1:806199016981:AmazonIpSpaceChanged"</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we demonstrated how we can create a strict firewall that only allows traffic to an EC2 instance from CloudFront and would avoid the risk of an attacker discovering the web server’s public IP address and reaching it directly. We also implemented an automated script that can immediately update the IP addresses in the firewall and keep them up to date.</p>

<p>By all means, the technique used in this blog could be applied in many different ways:</p>

<ul>
  <li>The IP address included in the SNS body (re: <a href="https://ip-ranges.amazonaws.com/ip-ranges.json">https://ip-ranges.amazonaws.com/ip-ranges.json</a>) lists the IP addresses of all services in AWS and could also be useful in case you want to restrict access based on a different service, such as ELB, Lambda, etc.</li>
  <li>The concept of hiding an EC2 instance behind an AWS service has many <em>offensive</em> use cases. For example, hiding phishing infrastructure or C2 infrastructure from being publicly exposed.</li>
</ul>

<p>Hopefully, this article can help you better attack and defend systems behind CloudFront.</p>

<p>The article was written by <a href="https://twitter.com/saldat0">@saldat0</a></p>
</article><div class="post__nav-wrapper">
        <h3 class="post__nav-heading">More articles</h3>

        <div class="post__nav"><a
            class="post__nav-item post__nav-item--prev"
            href="/building-a-research-environment-for-log4j/"
          >Building a Research Environment for Log4j</a></div>
      </div></div>
  </section>
</section><div id="lightbox" class="lightbox opacity-0 z_-10">
    <figure id="lightbox-figure" class="lightbox__figure">
        <img src="" alt="" class="lightbox__img">
        <figcaption class="lightbox__caption"></figcaption>
        <svg id="close-lightbox-control" class="lightbox__close" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>
    </figure>
</div>
    </main><footer class="site-footer">
    <div class="container">

        <div class="site-footer__logo-wrapper">
            <a href="/" class="site-footer__logo-link">
                <img class="site-footer__logo" src="/assets/images/secario-labs-logo.png" alt="Secario Labs logo" width="462" height="58">
            </a>
        </div>

        <div class="site-footer__cols site-footer__cols--3">

            <div class="site-footer__col site-footer__col--desc">

                <div class="site-footer__desc">
                    <p>Secario Labs offers expertly delivered cyber security services, security testing and solutions that are geared to your risk profile and security needs. Combining skills, experience and methodologies to provide offensive cyber security solutions.</p>

                </div>
            </div>

            <div class="site-footer__col site-footer__col--location">
                <p>
                    <strong>Bulgaria Office</strong><br>
                    66 Vitosha Blvd.<br>Sofia, 1463<br>Bulgaria
                </p>
                <p>
                    <a class="site-footer__link" href="tel:+359882357332">
                        +359 882 357332
                    </a>
                    <br>
                    <a class="site-footer__link" href="mailto:info@secariolabs.com">
                        info@secariolabs.com
                    </a>
                </p>
            </div>

            <div class="site-footer__col site-footer__col--location">
                <p>
                    <strong>UK Office</strong><br>
                    Worth Corner, Pound Hill,<br>Crawley, RH10 7SL<br>United Kingdom
                </p>
                <p>
                    <a class="site-footer__link" href="tel:+447389796754">
                        +44 7389 796754
                    </a>
                    <br>
                    <a class="site-footer__link" href="mailto:info@secariolabs.com">
                        info@secariolabs.com
                    </a>
                </p>                
            </div>

        </div>

        <div class="site-footer__cols site-footer__cols--2">
            <div class="site-footer__col">
                <label class="site-footer__form-label" for="email">Sign up to our newsletter</label><div id="mc_embed_shell">
    <link href="//cdn-images.mailchimp.com/embedcode/classic-061523.css" rel="stylesheet" type="text/css">
    <div id="mc_embed_signup">
        <form action="https://secariolabs.us6.list-manage.com/subscribe/post?u=daf217615566079f0ccc22426&amp;id=9fa5ad3243&amp;f_id=002628e3f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank">
            <div id="mc_embed_signup_scroll" class="site-footer__form-fields">
                <input type="email" name="EMAIL" class="required email input__text input__text--xl" id="mce-EMAIL" required="" value="" placeholder="Your email">
                <div style="position: absolute; left: -5000px;" aria-hidden="true">
                    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups -->
                    <input type="text" name="b_daf217615566079f0ccc22426_9fa5ad3243" tabindex="-1" value="">
                </div>
                <div class="optionalParent">
                    <div class="clear foot">
                        <input type="submit" name="subscribe" id="mc-embedded-subscribe" class="site-footer__form-submit btn btn--xl btn--light uppercase" value="Subscribe"></div>
                </div>
            </div>

            <div id="mce-responses" class="clear foot">
                <div class="response" id="mce-error-response" style="display: none;">😐 Error!</div>
                <div class="response" id="mce-success-response" style="display: none;">✅ Success!</div>
            </div>
        </form>
    </div>
    <script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script>
    <script type="text/javascript">
        (function($) {
            window.fnames = new Array();
            window.ftypes = new Array();
            fnames[0] = 'EMAIL';
            ftypes[0] = 'email';
            fnames[1] = 'FNAME';
            ftypes[1] = 'text';
            fnames[2] = 'LNAME';
            ftypes[2] = 'text';
            fnames[3] = 'ADDRESS';
            ftypes[3] = 'address';
            fnames[4] = 'PHONE';
            ftypes[4] = 'phone';
            fnames[5] = 'BIRTHDAY';
            ftypes[5] = 'birthday';
        }(jQuery));
        var $mcj = jQuery.noConflict(true);
    </script>
</div></div>
            <div class="site-footer__col">
                <h3 class="site-footer__social-heading">
                    Connect With Us
                </h3>
                <div class="site-footer__social">
                    <a href="https://www.linkedin.com/company/secariolabs" class="site-footer__social-item" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true" viewBox="0 0 24 24"><path d="M19.7 3H4.3A1.3 1.3 0 0 0 3 4.3v15.4A1.3 1.3 0 0 0 4.3 21h15.4a1.3 1.3 0 0 0 1.3-1.3V4.3A1.3 1.3 0 0 0 19.7 3zM8.339 18.338H5.667v-8.59h2.672v8.59zM7.004 8.574a1.548 1.548 0 1 1-.002-3.096 1.548 1.548 0 0 1 .002 3.096zm11.335 9.764H15.67v-4.177c0-.996-.017-2.278-1.387-2.278-1.389 0-1.601 1.086-1.601 2.206v4.249h-2.667v-8.59h2.559v1.174h.037c.356-.675 1.227-1.387 2.526-1.387 2.703 0 3.203 1.779 3.203 4.092v4.711z"/></svg></a>
                    <a href="https:/x.com/SecarioLabs" class="site-footer__social-item" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865z"/></svg></a>
                    <a href="mailto:info@secariolabs.com" class="site-footer__social-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true" viewBox="0 0 24 24"><path d="M19 5H5c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm.5 12c0 .3-.2.5-.5.5H5c-.3 0-.5-.2-.5-.5V9.8l7.5 5.6 7.5-5.6V17zm0-9.1L12 13.6 4.5 7.9V7c0-.3.2-.5.5-.5h14c.3 0 .5.2.5.5v.9z"/></svg></a>
                    
                </div>
            </div>
        </div>

        <div class="site-footer__bottom">
            <span class="site-footer__bottom-item">All content © 2024 Secario Labs
                    </span><a class="site-footer__bottom-item site-footer__link" href="/privacy-policy/">Privacy Policy</a><a class="site-footer__bottom-item site-footer__link" href="/modern-slavery-policy/">Modern Slavery Policy</a><a class="site-footer__bottom-item site-footer__link" href="/contact/">Contact</a>
        </div>

    </div>
</footer><div id="modal" class="lightbox modal opacity-0 z_-10" data-i_frame="https://outlook.office365.com/owa/calendar/SecarioLabs@secariolabs.com/bookings/">
    <div class="modal__container">
        <div class="modal__content-container">
            <iframe src='' width='100%' height='100%' scrolling='yes' style='border:0'></iframe>
        </div>
        <svg id="close-modal-control" class="lightbox__close modal__close" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>
    </div>
</div><script src="/assets/js/slidetoggle.js"></script><script src="/assets/js/prism.js"></script><script src="/assets/js/scripts.js"></script><script>function handle_lightbox(figure_elements, element_type){

    const lightbox = document.getElementById('lightbox');
    const lightbox_img = lightbox.querySelector('img');
    const lightbox_caption = lightbox.querySelector('figcaption');
    const figures = document.querySelectorAll(figure_elements);
    const the_figure = document.getElementById('lightbox-figure');
    const close_control = document.getElementById('close-lightbox-control');
    const the_body = document.querySelector('body');

    let the_img;
    let the_caption = '';
    
    function open_figure(e){
        const $this = e.currentTarget;

        if(element_type === 'figure'){
            the_img = $this.querySelector('img');
            if($this.querySelector('figcaption')){
                the_caption = $this.querySelector('figcaption').innerHTML;
                lightbox_caption.classList.add('py-0_5rem');
                lightbox_caption.classList.add('px-1rem');
            } else {
                the_caption = '';
            }

        } else if(element_type === 'img'){
            the_img = $this;
        }

        const the_src = the_img.src;

        the_body.classList.add('no-scroll');

        lightbox_img.src = the_src;
        lightbox_caption.innerHTML = the_caption;

        lightbox.classList.remove('z_-10');
        lightbox.classList.remove('opacity-0');
        lightbox.classList.add('opacity-1');

        the_figure.classList.add('translate-y-0');
    }
    
    function close_figure(){
        lightbox_img.src = '';
        lightbox_caption.innerHTML = '';

        the_body.classList.remove('no-scroll');

        lightbox_caption.classList.remove('py-0_5rem');
        lightbox_caption.classList.remove('px-1rem');

        the_figure.classList.remove('translate-y-0');

        lightbox.classList.remove('opacity-1');
        lightbox.classList.add('opacity-0');
        lightbox.classList.add('z_-10');
    }

    figures.forEach(function(el){
        el.addEventListener('click', open_figure);
    });

    close_control.addEventListener('click', close_figure);

    document.addEventListener('click', function(e){
        if(e.target.id === 'lightbox'){
            close_figure();
        }
    });

    window.addEventListener('keydown', keyPress);
    
    function keyPress (e) {
        if(e.key === "Escape") {
            close_figure();
        }
    }

}handle_lightbox('article.post p:has(img:only-of-type) img', 'img');
    </script><script>function handle_modal(){

    const modal = document.getElementById('modal');
    const the_container = modal.querySelector('.modal__container');
    const close_control = document.getElementById('close-modal-control');
    const the_body = document.querySelector('body');
    const iframe_url = modal.dataset.i_frame;
    const the_iframe = modal.querySelector('iframe');
    
    function open_modal(){

        the_iframe.src = iframe_url;

        the_body.classList.add('no-scroll');

        modal.classList.remove('z_-10');
        modal.classList.remove('opacity-0');
        modal.classList.add('opacity-1');

        the_container.classList.add('translate-y-0');
    }
    
    function close_modal(){

        the_iframe.src = '';
        
        the_body.classList.remove('no-scroll');

        the_container.classList.remove('translate-y-0');

        modal.classList.remove('opacity-1');
        modal.classList.add('opacity-0');
        modal.classList.add('z_-10');
    }

    close_control.addEventListener('click', close_modal);

    document.addEventListener('click', function(e){
        if(e.target.id === 'modal'){
            close_modal();
        }
    });

    window.addEventListener('keydown', keyPress);
    
    function keyPress (e) {
        if(e.key === "Escape") {
            close_modal();
        }
    }

    document.querySelectorAll('[data-open-modal]').forEach(function(el){
        el.addEventListener('click', function(e){
            e.preventDefault();
            open_modal();
        });
    });

}

handle_modal()</script></body>

</html>
